<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ConCiencia ¬∑ Sopa de Letras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%239b7bff' d='M12 21s-8-6.58-8-11.5S7.58 2 12 7.09 20 2 20 9.5 12 21 12 21z'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --primary: #9b7bff;
  --primary-light: #c8b6ff;
  --primary-dark: #6a54ff;
  --bg: #f6f3ff;
  --card: #ffffff;
  --text: #2d2d2d;
  --deep: #3c2f7a;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #f6f3ff, #efeaff);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
  user-select: none;
}

header {
  background: linear-gradient(90deg, #8f6fff, #6a54ff);
  color: white;
  padding: 15px 20px;
  text-align: center;
  font-weight: 600;
  font-size: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  flex-shrink: 0;
}
footer { text-align: center; padding: 10px; font-size: 12px; color: #999; flex-shrink: 0; }

/* SCREENS */
.screen { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.screen.active { display: flex; }

/* BUTTONS */
.btn {
  padding: 11px 26px; border-radius: 50px; border: none;
  font-family: Poppins; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
  transition: transform 0.2s, box-shadow 0.2s; white-space: nowrap;
}
.btn:hover  { transform: scale(1.05); }
.btn:active { transform: scale(0.97); }
.btn-primary   { background: linear-gradient(90deg, #9b7bff, #6a54ff); color: white; box-shadow: 0 5px 18px rgba(106,84,255,0.32); }
.btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
.btn-back {
  align-self: flex-start; background: none; border: 2px solid var(--primary);
  color: var(--primary); padding: 7px 16px; border-radius: 50px; cursor: pointer;
  font-family: Poppins; font-size: 12px; font-weight: 600; margin-bottom: 18px;
  transition: 0.3s; display: flex; align-items: center; gap: 6px;
}
.btn-back:hover { background: var(--primary); color: white; }

/* ===== SELECT SCREEN ===== */
.screen-title { font-size: 38px; font-weight: 700; color: var(--deep); margin-bottom: 6px; animation: fadeUp 0.7s both; }
.screen-sub   { color: #777; margin-bottom: 30px; font-size: 14px; animation: fadeUp 0.9s both; }

.diff-cards { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; animation: fadeUp 1.1s both; }
.diff-card {
  background: white; border-radius: 22px; width: 190px; padding: 26px 18px 22px;
  text-align: center; cursor: pointer; box-shadow: 0 8px 26px rgba(0,0,0,0.09);
  transition: 0.3s; border: 3px solid transparent; position: relative; overflow: hidden;
}
.diff-card:hover { transform: translateY(-9px) scale(1.03); box-shadow: 0 20px 40px rgba(0,0,0,0.14); }
.diff-card.easy:hover   { border-color: #7be0ad; }
.diff-card.medium:hover { border-color: #ffc844; }
.diff-card.hard:hover   { border-color: #ff6b6b; }
.diff-icon { font-size: 40px; margin-bottom: 12px; display: block; }
.diff-name { font-size: 18px; font-weight: 700; color: var(--deep); margin-bottom: 6px; }
.diff-info { font-size: 11px; color: #999; line-height: 1.7; }
.diff-badge { display: inline-block; padding: 3px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; margin-top: 10px; }
.easy   .diff-badge { background: #e6faf2; color: #2ecc71; }
.medium .diff-badge { background: #fff8e6; color: #f39c12; }
.hard   .diff-badge { background: #ffe6e6; color: #e74c3c; }

/* LEADERBOARD */
.leaderboard-wrap {
  margin-top: 30px; background: white; border-radius: 18px; padding: 18px 22px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08); width: 100%; max-width: 520px; animation: fadeUp 1.3s both;
}
.lb-title  { font-weight: 700; color: var(--deep); font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 7px; }
.lb-tabs   { display: flex; gap: 6px; margin-bottom: 12px; }
.lb-tab    { padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; cursor: pointer; border: 2px solid #e0d9ff; background: white; color: #999; transition: 0.2s; }
.lb-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
.lb-list   { list-style: none; }
.lb-row    { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid #f3efff; font-size: 13px; }
.lb-row:last-child { border-bottom: none; }
.lb-pos    { font-weight: 700; color: var(--primary-light); width: 22px; text-align: center; font-size: 14px; }
.lb-name   { flex: 1; font-weight: 600; color: var(--deep); }
.lb-time   { font-weight: 700; color: var(--primary); font-size: 12px; }
.lb-empty  { text-align: center; color: #bbb; font-size: 12px; padding: 10px 0; }

/* ===== GAME SCREEN ===== */
#screen-game {
  padding: 12px 16px 16px;
  justify-content: flex-start;
  align-items: stretch;
  gap: 10px;
}

.game-topbar {
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap; flex-shrink: 0;
}

/* Circular timer */
.timer-wrap { position: relative; width: 64px; height: 64px; flex-shrink: 0; }
.timer-svg  { transform: rotate(-90deg); width: 64px; height: 64px; }
.timer-bg   { fill: none; stroke: #e0d9ff; stroke-width: 6; }
.timer-fill { fill: none; stroke: url(#timerGrad); stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.9s linear; }
.timer-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: var(--deep); line-height: 1; flex-direction: column; gap: 0; }
.timer-text span { font-size: 10px; color: #aaa; font-weight: 400; }
.timer-text.urgent { color: #ff6b6b; animation: tPulse 0.5s infinite alternate; }
@keyframes tPulse { from { transform: scale(1); } to { transform: scale(1.1); } }

.game-info { display: flex; flex-direction: column; gap: 2px; }
.game-diff-label { font-size: 11px; color: #aaa; font-weight: 500; }
.game-found-label { font-size: 18px; font-weight: 700; color: var(--deep); }

/* GAME BODY: grid + word list side by side */
.game-body {
  display: flex;
  gap: 14px;
  flex: 1;
  align-items: flex-start;
  justify-content: center;
}

/* GRID WRAPPER */
.grid-wrap {
  background: white;
  border-radius: 18px;
  padding: 12px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.1);
  flex-shrink: 0;
  touch-action: none;
  position: relative;
}

.grid-table {
  border-collapse: separate;
  border-spacing: 2px;
}

.grid-cell {
  width: 34px; height: 34px;
  text-align: center;
  vertical-align: middle;
  font-family: "Space Mono", monospace;
  font-size: 15px;
  font-weight: 700;
  color: #4a3f7a;
  border-radius: 6px;
  background: #f8f5ff;
  cursor: pointer;
  transition: background 0.1s, color 0.1s, transform 0.1s;
  position: relative;
}

.grid-cell.size-sm { width: 28px; height: 28px; font-size: 12px; }
.grid-cell.size-xs { width: 24px; height: 24px; font-size: 10px; }

.grid-cell.selecting {
  background: #c8b6ff;
  color: white;
  transform: scale(1.08);
}

.grid-cell.found-0  { background: #a29bfe; color: white; }
.grid-cell.found-1  { background: #fd79a8; color: white; }
.grid-cell.found-2  { background: #55efc4; color: #1a6a5e; }
.grid-cell.found-3  { background: #fdcb6e; color: #7a5200; }
.grid-cell.found-4  { background: #74b9ff; color: #1a4a7a; }
.grid-cell.found-5  { background: #e17055; color: white; }
.grid-cell.found-6  { background: #00b894; color: white; }
.grid-cell.found-7  { background: #6c5ce7; color: white; }
.grid-cell.found-8  { background: #fab1a0; color: #7a3020; }
.grid-cell.found-9  { background: #81ecec; color: #1a6a6a; }

.grid-cell.wrong-flash { animation: wrongFlash 0.4s ease; }
@keyframes wrongFlash {
  0%,100% { background: #f8f5ff; }
  30%     { background: #ffeaea; transform: scale(0.96); }
}

/* WORD LIST */
.word-list-wrap {
  background: white;
  border-radius: 18px;
  padding: 14px 16px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.1);
  min-width: 150px;
  max-width: 180px;
}

.word-list-title { font-size: 12px; font-weight: 600; color: #aaa; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

.word-item {
  font-size: 13px;
  font-weight: 600;
  color: var(--deep);
  padding: 5px 0;
  border-bottom: 1px solid #f3efff;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: 0.25s;
  font-family: "Space Mono", monospace;
}
.word-item:last-child { border-bottom: none; }
.word-item.found {
  text-decoration: line-through;
  color: #bbb;
}
.word-item .wi-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #e0d9ff;
  flex-shrink: 0;
  transition: 0.25s;
}
.word-item.found .wi-dot { background: var(--primary); }

/* ===== RESULT SCREENS ===== */
#screen-win, #screen-lose { text-align: center; }
.result-icon  { font-size: 68px; margin-bottom: 8px; animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
.result-title { font-size: 36px; font-weight: 700; color: var(--deep); margin-bottom: 6px; animation: fadeUp 0.5s 0.2s both; }
.result-sub   { color: #777; font-size: 14px; margin-bottom: 20px; line-height: 1.6; max-width: 380px; animation: fadeUp 0.5s 0.3s both; }
.result-time  { font-size: 40px; font-weight: 700; color: var(--primary); animation: fadeUp 0.5s 0.4s both; margin-bottom: 2px; }
.result-time-label { font-size: 12px; color: #aaa; margin-bottom: 24px; animation: fadeUp 0.5s 0.45s both; }
.result-btns  { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; animation: fadeUp 0.5s 0.55s both; }

.score-form { margin: 16px 0; animation: fadeUp 0.5s 0.5s both; }
.score-form-label { font-size: 13px; color: #777; margin-bottom: 8px; }
.score-input-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.score-input {
  border: 2px solid #e0d9ff; border-radius: 50px; padding: 9px 16px;
  font-family: Poppins; font-size: 13px; outline: none; width: 190px;
  transition: 0.2s; text-align: center;
}
.score-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(155,123,255,0.15); }

/* TOAST */
.toast {
  position: fixed; bottom: 18px; right: 18px;
  background: linear-gradient(90deg, #9b7bff, #6a54ff);
  color: white; padding: 12px 18px; border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18); opacity: 0;
  transform: translateY(16px); transition: 0.4s; z-index: 800;
  max-width: 260px; font-size: 13px; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }

@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn  { from { transform: scale(0.4); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<header>ConCiencia Emocional Digital</header>

<!-- ===== SELECT ===== -->
<div class="screen active" id="screen-select">
  <button class="btn btn-back" onclick="window.location.href='minijuegos.html'">
    <i class="fa fa-arrow-left"></i> Minijuegos
  </button>
  <div class="screen-title">Sopa de Letras</div>
  <div class="screen-sub">Encuentra las palabras ocultas antes de que se acabe el tiempo</div>
  <div class="diff-cards">
    <div class="diff-card easy" onclick="startGame('easy')">
      <span class="diff-icon">üòä</span>
      <div class="diff-name">F√°cil</div>
      <div class="diff-info">3 palabras<br>Cuadr√≠cula 10√ó10<br>10 minutos</div>
      <span class="diff-badge">Solo horizontal/vertical</span>
    </div>
    <div class="diff-card medium" onclick="startGame('medium')">
      <span class="diff-icon">ü§î</span>
      <div class="diff-name">Medio</div>
      <div class="diff-info">5 palabras<br>Cuadr√≠cula 13√ó13<br>10 minutos</div>
      <span class="diff-badge">+ Diagonales</span>
    </div>
    <div class="diff-card hard" onclick="startGame('hard')">
      <span class="diff-icon">üî•</span>
      <div class="diff-name">Dif√≠cil</div>
      <div class="diff-info">10 palabras<br>Cuadr√≠cula 17√ó17<br>10 minutos</div>
      <span class="diff-badge">Todas direcciones</span>
    </div>
  </div>

  <div class="leaderboard-wrap">
    <div class="lb-title"><i class="fa fa-trophy" style="color:#ffd700"></i> Mejores tiempos</div>
    <div class="lb-tabs">
      <button class="lb-tab active" onclick="showLbTab('easy',this)">F√°cil</button>
      <button class="lb-tab" onclick="showLbTab('medium',this)">Medio</button>
      <button class="lb-tab" onclick="showLbTab('hard',this)">Dif√≠cil</button>
    </div>
    <ul class="lb-list" id="lbList"></ul>
  </div>
</div>

<!-- ===== GAME ===== -->
<div class="screen" id="screen-game">
  <div class="game-topbar">
    <button class="btn btn-secondary" onclick="quitGame()" style="padding:7px 14px;font-size:12px;">
      <i class="fa fa-arrow-left"></i> Salir
    </button>
    <div class="timer-wrap">
      <svg class="timer-svg" viewBox="0 0 64 64">
        <defs>
          <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#9b7bff"/>
            <stop offset="100%" style="stop-color:#6a54ff"/>
          </linearGradient>
        </defs>
        <circle class="timer-bg"   cx="32" cy="32" r="26"/>
        <circle class="timer-fill" id="timerCircle" cx="32" cy="32" r="26"/>
      </svg>
      <div class="timer-text" id="timerText">
        10:00<span>min</span>
      </div>
    </div>
    <div class="game-info">
      <div class="game-diff-label" id="gameDiffLabel">F√°cil</div>
      <div class="game-found-label" id="gameFoundLabel">0 / 3 encontradas</div>
    </div>
  </div>

  <div class="game-body">
    <div class="grid-wrap" id="gridWrap">
      <table class="grid-table" id="gridTable"></table>
    </div>
    <div class="word-list-wrap">
      <div class="word-list-title">Palabras</div>
      <div id="wordList"></div>
    </div>
  </div>
</div>

<!-- ===== WIN ===== -->
<div class="screen" id="screen-win">
  <div class="result-icon">üéâ</div>
  <div class="result-title">¬°Lo encontraste todo!</div>
  <div class="result-sub" id="winMsg">Excelente concentraci√≥n y paciencia.</div>
  <div class="result-time" id="winTime">00:00</div>
  <div class="result-time-label">tiempo que tardaste</div>

  <div class="score-form" id="scoreForm">
    <div class="score-form-label">¬øGuardar tu resultado en el top?</div>
    <div class="score-input-row">
      <input class="score-input" id="scoreNameInput" type="text" placeholder="Tu nombre..." maxlength="16">
      <button class="btn btn-primary" onclick="saveScore()"><i class="fa fa-check"></i> Guardar</button>
      <button class="btn btn-secondary" id="btnSkip" onclick="skipScore()"><i class="fa fa-forward"></i> Omitir</button>
    </div>
  </div>
  <div class="result-btns" id="winBtns" style="display:none;">
    <button class="btn btn-primary" onclick="retryGame()"><i class="fa fa-rotate-right"></i> Jugar de nuevo</button>
    <button class="btn btn-secondary" onclick="showScreen('screen-select');renderLeaderboard()"><i class="fa fa-home"></i> Men√∫</button>
  </div>
</div>

<!-- ===== LOSE ===== -->
<div class="screen" id="screen-lose">
  <div class="result-icon">‚è∞</div>
  <div class="result-title">¬°Se acab√≥ el tiempo!</div>
  <div class="result-sub" id="loseMsg">No te rindas, ¬°int√©ntalo de nuevo!</div>
  <div class="result-btns" style="margin-top:10px;">
    <button class="btn btn-primary" onclick="retryGame()"><i class="fa fa-rotate-right"></i> Volver a intentar</button>
    <button class="btn btn-secondary" onclick="showScreen('screen-select');renderLeaderboard()"><i class="fa fa-home"></i> Inicio</button>
  </div>
</div>

<footer>¬© 2026 ConCiencia ¬∑ Plataforma educativa emocional</footer>
<div class="toast" id="toast"></div>

<script>
/* =====================================================================
   WORD BANK ‚Äî 50 palabras emocionales
   ===================================================================== */
const ALL_WORDS = [
  // Proporcionadas
  'CONCIENCIA','ALEGRIA','ENOJO','TRISTEZA','FRUSTRACION',
  'ASOMBRO','PACIENCIA','EMPATIA','INDEPENDENCIA','AMOR',
  'MIEDO','CARINO',
  // Inventadas del mismo estilo
  'GRATITUD','ESPERANZA','CALMA','PERDON','RESPETO',
  'VALENTIA','LIBERTAD','CONFIANZA','ANGUSTIA','NOSTALGIA',
  'ORGULLO','TERNURA','SOLEDAD','FELICIDAD','ARMONIA',
  'SERENIDAD','PASION','ENTUSIASMO','COMPASION','DIGNIDAD',
  'HUMILDAD','GENEROSIDAD','VOLUNTAD','FORTALEZA','CURIOSIDAD',
  'REFLEXION','INTUICION','CREATIVIDAD','ACEPTACION','BONDAD',
  'EQUILIBRIO','MOTIVACION','RESILIENCIA','AUTOESTIMA','BIENESTAR',
  'CONEXION','PLENITUD','VITALIDAD'
];

/* =====================================================================
   DIFFICULTY CONFIG
   ===================================================================== */
const DIFF = {
  easy:   { label:'F√°cil',   words:3,  size:10, time:600, dirs:['LR','TD'], cellClass:'',      cellPx:34 },
  medium: { label:'Medio',   words:5,  size:13, time:600, dirs:['LR','RL','TD','DT','DR','DL'], cellClass:'size-sm', cellPx:28 },
  hard:   { label:'Dif√≠cil', words:10, size:17, time:600, dirs:['LR','RL','TD','DT','DR','DL','UR','UL'], cellClass:'size-xs', cellPx:24 },
};

const WIN_MSGS = [
  'Tu concentraci√≥n es admirable. ¬°Sigue ejercitando tu mente!',
  '¬°Eres imparable! Cada palabra encontrada es un logro.',
  'Agudeza visual y paciencia: tus superpoderes. üß†',
  'Incre√≠ble foco. Tu mente trabaja de maravilla.',
  'Lo lograste con elegancia. ¬°Orgullo propio!',
];
const LOSE_MSGS = [
  'Casi lo tienes. Un intento m√°s y lo logras. üíú',
  'El tiempo vuela, pero tu mente puede m√°s. ¬°Int√©ntalo!',
  'No te rindas. Cada intento entrena tu cerebro.',
  'La pr√°ctica hace al maestro. ¬°Vuelve a intentarlo!',
  'Tu perseverancia te llevar√° lejos. ¬°Sigue adelante!',
];

/* =====================================================================
   STATE
   ===================================================================== */
let currentDiff   = 'easy';
let grid          = [];       // 2D array of letters
let placed        = [];       // [{word, cells:[{r,c}], dir, colorIdx}]
let wordsToFind   = [];
let foundWords    = [];
let selecting     = false;
let selStart      = null;     // {r,c}
let selCurrent    = null;     // {r,c}
let selCells      = [];       // [{r,c}] currently highlighted
let timeLeft      = 600;
let totalTime     = 600;
let timerInterval = null;
let gameRunning   = false;
let startTime     = 0;
let winTimeMs     = 0;
const CIRC        = 2 * Math.PI * 26;

/* =====================================================================
   DIRECTION VECTORS
   ===================================================================== */
const DIR_VECTORS = {
  LR:{ dr:0,  dc:1  },
  RL:{ dr:0,  dc:-1 },
  TD:{ dr:1,  dc:0  },
  DT:{ dr:-1, dc:0  },
  DR:{ dr:1,  dc:1  },
  DL:{ dr:1,  dc:-1 },
  UR:{ dr:-1, dc:1  },
  UL:{ dr:-1, dc:-1 },
};

/* =====================================================================
   START GAME
   ===================================================================== */
function startGame(diff) {
  currentDiff = diff;
  const cfg   = DIFF[diff];
  timeLeft    = cfg.time;
  totalTime   = cfg.time;
  foundWords  = [];
  selecting   = false;
  selStart    = null;
  selCells    = [];
  gameRunning = true;
  startTime   = Date.now();

  // Pick random words that fit in grid
  const size = cfg.size;
  const pool = shuffle([...ALL_WORDS]).filter(w => w.length <= size - 1);
  wordsToFind = pool.slice(0, cfg.words);

  // Build grid
  grid = buildGrid(size, wordsToFind, cfg.dirs);
  placed = grid._placed;
  delete grid._placed;

  showScreen('screen-game');
  renderGrid(cfg);
  renderWordList();
  updateHUD();
  startTimer();
}

function retryGame() { startGame(currentDiff); }

function quitGame() {
  stopTimer();
  gameRunning = false;
  showScreen('screen-select');
  renderLeaderboard();
}

/* =====================================================================
   GRID BUILDER
   ===================================================================== */
function buildGrid(size, words, dirs) {
  // Initialize empty grid
  const g = Array.from({length:size}, () => Array(size).fill(''));
  const placedList = [];

  // Try to place each word
  words.forEach((word, wi) => {
    let placed = false;
    let attempts = 0;
    while (!placed && attempts < 300) {
      attempts++;
      const dir = dirs[randInt(0, dirs.length-1)];
      const vec = DIR_VECTORS[dir];
      const len = word.length;

      // Starting position bounds
      const rMin = vec.dr < 0 ? len-1 : 0;
      const rMax = vec.dr > 0 ? size-len : size-1;
      const cMin = vec.dc < 0 ? len-1 : 0;
      const cMax = vec.dc > 0 ? size-len : size-1;

      if (rMin > rMax || cMin > cMax) continue;

      const r0 = randInt(rMin, rMax);
      const c0 = randInt(cMin, cMax);

      // Check if cells are free or same letter
      let ok = true;
      const cells = [];
      for (let i = 0; i < len; i++) {
        const r = r0 + i*vec.dr;
        const c = c0 + i*vec.dc;
        if (g[r][c] !== '' && g[r][c] !== word[i]) { ok = false; break; }
        cells.push({r, c});
      }
      if (!ok) continue;

      // Place word
      cells.forEach(({r,c}, i) => { g[r][c] = word[i]; });
      placedList.push({word, cells, dir, colorIdx: wi});
      placed = true;
    }
  });

  // Fill remaining cells with random letters
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  for (let r = 0; r < size; r++) {
    for (let c = 0; c < size; c++) {
      if (g[r][c] === '') g[r][c] = letters[randInt(0, 25)];
    }
  }

  g._placed = placedList;
  return g;
}

/* =====================================================================
   RENDER GRID
   ===================================================================== */
function renderGrid(cfg) {
  const table = document.getElementById('gridTable');
  table.innerHTML = '';
  const size = cfg.size;
  const cls  = cfg.cellClass;

  for (let r = 0; r < size; r++) {
    const tr = document.createElement('tr');
    for (let c = 0; c < size; c++) {
      const td = document.createElement('td');
      td.className  = `grid-cell${cls ? ' '+cls : ''}`;
      td.textContent = grid[r][c];
      td.dataset.r   = r;
      td.dataset.c   = c;

      // Mouse events
      td.addEventListener('mousedown',  e => { e.preventDefault(); startSelect(r,c); });
      td.addEventListener('mouseover',  e => { if(selecting) updateSelect(r,c); });
      td.addEventListener('mouseup',    e => { endSelect(); });

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }

  // Touch events on grid wrap
  const wrap = document.getElementById('gridWrap');
  wrap.ontouchstart = e => {
    e.preventDefault();
    const cell = cellFromTouch(e.touches[0]);
    if(cell) startSelect(cell.r, cell.c);
  };
  wrap.ontouchmove = e => {
    e.preventDefault();
    const cell = cellFromTouch(e.touches[0]);
    if(cell && selecting) updateSelect(cell.r, cell.c);
  };
  wrap.ontouchend = e => { e.preventDefault(); endSelect(); };
  document.addEventListener('mouseup', endSelect);
}

function cellFromTouch(touch) {
  const el = document.elementFromPoint(touch.clientX, touch.clientY);
  if (el && el.classList.contains('grid-cell')) {
    return { r: parseInt(el.dataset.r), c: parseInt(el.dataset.c) };
  }
  return null;
}

/* =====================================================================
   SELECTION LOGIC
   ===================================================================== */
function startSelect(r, c) {
  selecting  = true;
  selStart   = {r, c};
  selCurrent = {r, c};
  selCells   = [{r, c}];
  applySelectionHighlight();
}

function updateSelect(r, c) {
  if (!selecting || !selStart) return;
  selCurrent = {r, c};
  selCells = computeLineCells(selStart, selCurrent);
  applySelectionHighlight();
}

function endSelect() {
  if (!selecting) return;
  selecting = false;
  clearSelectionHighlight();

  if (selCells.length < 2) { selCells = []; return; }

  const word = selCells.map(({r,c}) => grid[r][c]).join('');
  checkWord(word, selCells);
  selCells = [];
  selStart  = null;
}

/* =====================================================================
   LINE CELLS ‚Äî snap selection to 8 directions
   ===================================================================== */
function computeLineCells(from, to) {
  const dr = to.r - from.r;
  const dc = to.c - from.c;
  const dist = Math.max(Math.abs(dr), Math.abs(dc));
  if (dist === 0) return [from];

  // Snap to nearest axis/diagonal
  const stepR = dr === 0 ? 0 : (dr > 0 ? 1 : -1);
  const stepC = dc === 0 ? 0 : (dc > 0 ? 1 : -1);

  // Only allow straight or 45¬∞ diagonal (step both or one)
  const cells = [];
  for (let i = 0; i <= dist; i++) {
    cells.push({ r: from.r + i*stepR, c: from.c + i*stepC });
  }
  return cells;
}

function applySelectionHighlight() {
  // Clear previous
  document.querySelectorAll('.grid-cell.selecting').forEach(el => el.classList.remove('selecting'));
  selCells.forEach(({r,c}) => {
    const el = cellEl(r,c);
    if (el) el.classList.add('selecting');
  });
}

function clearSelectionHighlight() {
  document.querySelectorAll('.grid-cell.selecting').forEach(el => el.classList.remove('selecting'));
}

function cellEl(r, c) {
  return document.querySelector(`.grid-cell[data-r="${r}"][data-c="${c}"]`);
}

/* =====================================================================
   CHECK WORD
   ===================================================================== */
function checkWord(word, cells) {
  // Check forward and backward
  for (const p of placed) {
    if (foundWords.includes(p.word)) continue;
    if (word === p.word || word === p.word.split('').reverse().join('')) {
      // Make sure cells match exactly
      const cellsMatch = (
        cells.length === p.cells.length &&
        (
          cells.every((c,i) => c.r === p.cells[i].r && c.c === p.cells[i].c) ||
          cells.every((c,i) => c.r === p.cells[p.cells.length-1-i].r && c.c === p.cells[p.cells.length-1-i].c)
        )
      );
      if (cellsMatch) {
        // Mark as found
        foundWords.push(p.word);
        p.cells.forEach(({r,c}) => {
          const el = cellEl(r,c);
          if (el) {
            el.classList.remove('selecting');
            el.classList.add(`found-${p.colorIdx}`);
          }
        });
        markWordFound(p.word);
        updateHUD();
        showToast(`¬°Encontraste "${p.word.toLowerCase()}"! ‚ú®`);

        if (foundWords.length === wordsToFind.length) {
          stopTimer();
          gameRunning = false;
          winTimeMs = Date.now() - startTime;
          setTimeout(showWin, 500);
        }
        return;
      }
    }
  }

  // Wrong ‚Äî flash cells briefly
  cells.forEach(({r,c}) => {
    const el = cellEl(r,c);
    if (el) {
      el.classList.remove('selecting');
      el.classList.add('wrong-flash');
      setTimeout(() => el.classList.remove('wrong-flash'), 450);
    }
  });
}

/* =====================================================================
   WORD LIST
   ===================================================================== */
function renderWordList() {
  const container = document.getElementById('wordList');
  container.innerHTML = '';
  wordsToFind.forEach(w => {
    const div = document.createElement('div');
    div.className = 'word-item';
    div.id = `wi-${w}`;
    div.innerHTML = `<span class="wi-dot"></span>${w.toLowerCase()}`;
    container.appendChild(div);
  });
}

function markWordFound(word) {
  const el = document.getElementById(`wi-${word}`);
  if (el) el.classList.add('found');
}

/* =====================================================================
   HUD
   ===================================================================== */
function updateHUD() {
  const cfg = DIFF[currentDiff];
  document.getElementById('gameDiffLabel').textContent   = cfg.label;
  document.getElementById('gameFoundLabel').textContent  = `${foundWords.length} / ${wordsToFind.length} encontradas`;
}

/* =====================================================================
   TIMER
   ===================================================================== */
function startTimer() {
  stopTimer();
  updateTimerUI();
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    if (timeLeft <= 0) {
      stopTimer();
      gameRunning = false;
      showLose();
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

function updateTimerUI() {
  const circle = document.getElementById('timerCircle');
  const text   = document.getElementById('timerText');
  const pct    = timeLeft / totalTime;
  const offset = CIRC * (1 - pct);

  circle.style.strokeDasharray  = CIRC;
  circle.style.strokeDashoffset = offset;

  const mins = Math.floor(timeLeft / 60);
  const secs = timeLeft % 60;
  text.innerHTML = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}<span>min</span>`;

  if (pct > 0.4) {
    circle.style.stroke = 'url(#timerGrad)';
    text.className = 'timer-text';
  } else if (pct > 0.15) {
    circle.style.stroke = '#ffc844';
    text.className = 'timer-text';
  } else {
    circle.style.stroke = '#ff6b6b';
    text.className = 'timer-text urgent';
  }
}

/* =====================================================================
   WIN / LOSE
   ===================================================================== */
function showWin() {
  const elapsed = winTimeMs / 1000;
  const mins = Math.floor(elapsed / 60);
  const secs = (elapsed % 60).toFixed(1);
  document.getElementById('winTime').textContent = `${String(mins).padStart(2,'0')}:${String(Math.floor(secs)).padStart(2,'0')}`;
  document.getElementById('winMsg').textContent  = WIN_MSGS[randInt(0, WIN_MSGS.length-1)];
  document.getElementById('scoreNameInput').value = '';
  document.getElementById('scoreForm').style.display = '';
  document.getElementById('winBtns').style.display   = 'none';
  document.getElementById('btnSkip').style.display   = '';
  showScreen('screen-win');
}

function showLose() {
  document.getElementById('loseMsg').textContent = LOSE_MSGS[randInt(0, LOSE_MSGS.length-1)];
  showScreen('screen-lose');
}

/* =====================================================================
   SCORE
   ===================================================================== */
function saveScore() {
  const name = document.getElementById('scoreNameInput').value.trim();
  if (!name) { showToast('Escribe tu nombre primero üòä'); return; }

  const elapsed = winTimeMs / 1000;
  const key  = `ws_scores_${currentDiff}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  list.push({ name, time: elapsed, diff: currentDiff });
  list.sort((a,b) => a.time - b.time);
  if (list.length > 10) list.splice(10);
  localStorage.setItem(key, JSON.stringify(list));

  document.getElementById('scoreForm').style.display = 'none';
  document.getElementById('winBtns').style.display   = 'flex';
  showToast('¬°Puntaje guardado! üèÜ');
  renderLeaderboard();
}

function skipScore() {
  document.getElementById('scoreForm').style.display = 'none';
  document.getElementById('winBtns').style.display   = 'flex';
}

/* =====================================================================
   LEADERBOARD
   ===================================================================== */
let currentLbTab = 'easy';

function showLbTab(diff, btn) {
  currentLbTab = diff;
  document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const key  = `ws_scores_${currentLbTab}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  const ul   = document.getElementById('lbList');
  ul.innerHTML = '';

  if (!list.length) {
    ul.innerHTML = '<li class="lb-empty">A√∫n no hay puntajes. ¬°S√© el primero!</li>';
    return;
  }

  list.forEach((entry, i) => {
    const mins = Math.floor(entry.time / 60);
    const secs = Math.floor(entry.time % 60);
    const ts   = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i+1}`;
    ul.innerHTML += `
      <li class="lb-row">
        <span class="lb-pos">${medal}</span>
        <span class="lb-name">${escHtml(entry.name)}</span>
        <span class="lb-time">${ts}</span>
      </li>`;
  });
}

/* =====================================================================
   UTILS
   ===================================================================== */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function shuffle(arr) {
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function randInt(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

/* BOOT */
renderLeaderboard();
</script>
</body>
</html>
