<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ConCiencia ¬∑ Memorama</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%239b7bff' d='M12 21s-8-6.58-8-11.5S7.58 2 12 7.09 20 2 20 9.5 12 21 12 21z'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --primary: #9b7bff;
  --primary2: #6a54ff;
  --primary-light: #c8b6ff;
  --bg: #f6f3ff;
  --bg2: #efeaff;
  --card: #ffffff;
  --text: #2d2d2d;
  --deep: #3c2f7a;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, var(--bg), var(--bg2));
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

header {
  background: linear-gradient(90deg, #8f6fff, #6a54ff);
  color: white;
  padding: 14px 20px;
  text-align: center;
  font-weight: 600;
  font-size: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.12);
  flex-shrink: 0;
}
footer { text-align: center; padding: 8px; font-size: 12px; color: #999; flex-shrink: 0; }

/* ===== SCREENS ===== */
.screen { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.screen.active { display: flex; }

/* ===== BUTTONS ===== */
.btn {
  padding: 11px 26px; border-radius: 50px; border: none;
  font-family: Poppins; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
  transition: transform 0.2s, box-shadow 0.2s; white-space: nowrap;
}
.btn:hover  { transform: scale(1.05); }
.btn:active { transform: scale(0.97); }
.btn-primary   { background: linear-gradient(90deg, #9b7bff, #6a54ff); color: white; box-shadow: 0 5px 18px rgba(106,84,255,0.32); }
.btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
.btn-back {
  align-self: flex-start; background: none; border: 2px solid var(--primary);
  color: var(--primary); padding: 7px 16px; border-radius: 50px; cursor: pointer;
  font-family: Poppins; font-size: 12px; font-weight: 600; margin-bottom: 18px;
  transition: 0.3s; display: flex; align-items: center; gap: 6px;
}
.btn-back:hover { background: var(--primary); color: white; }

/* ===== SELECT SCREEN ===== */
.screen-title { font-size: 38px; font-weight: 700; color: var(--deep); margin-bottom: 6px; animation: fadeUp 0.7s both; }
.screen-sub   { color: #777; margin-bottom: 28px; font-size: 14px; animation: fadeUp 0.9s both; text-align: center; }

.diff-cards { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; animation: fadeUp 1.1s both; }
.diff-card {
  background: white; border-radius: 22px; width: 195px; padding: 26px 18px 22px;
  text-align: center; cursor: pointer; box-shadow: 0 8px 26px rgba(0,0,0,0.09);
  transition: 0.3s; border: 3px solid transparent;
}
.diff-card:hover { transform: translateY(-9px) scale(1.03); box-shadow: 0 20px 40px rgba(0,0,0,0.14); }
.diff-card.easy:hover   { border-color: #7be0ad; }
.diff-card.medium:hover { border-color: #ffc844; }
.diff-card.hard:hover   { border-color: #ff6b6b; }
.diff-icon { font-size: 40px; margin-bottom: 12px; display: block; }
.diff-name { font-size: 18px; font-weight: 700; color: var(--deep); margin-bottom: 6px; }
.diff-info { font-size: 11px; color: #999; line-height: 1.8; }
.diff-badge { display: inline-block; padding: 3px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; margin-top: 10px; }
.easy   .diff-badge { background: #e6faf2; color: #2ecc71; }
.medium .diff-badge { background: #fff8e6; color: #f39c12; }
.hard   .diff-badge { background: #ffe6e6; color: #e74c3c; }

/* LEADERBOARD */
.leaderboard-wrap {
  margin-top: 28px; background: white; border-radius: 18px; padding: 18px 22px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08); width: 100%; max-width: 520px; animation: fadeUp 1.3s both;
}
.lb-title  { font-weight: 700; color: var(--deep); font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 7px; }
.lb-tabs   { display: flex; gap: 6px; margin-bottom: 12px; }
.lb-tab    { padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; cursor: pointer; border: 2px solid #e0d9ff; background: white; color: #999; transition: 0.2s; }
.lb-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
.lb-list   { list-style: none; }
.lb-row    { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid #f3efff; font-size: 13px; }
.lb-row:last-child { border-bottom: none; }
.lb-pos    { font-weight: 700; color: var(--primary-light); width: 24px; text-align: center; font-size: 14px; }
.lb-name   { flex: 1; font-weight: 600; color: var(--deep); }
.lb-time   { font-weight: 700; color: var(--primary); font-size: 12px; }
.lb-empty  { text-align: center; color: #bbb; font-size: 12px; padding: 10px 0; }

/* ===== PREVIEW SCREEN ===== */
#screen-preview {
  gap: 0;
  padding: 20px;
}

.preview-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--deep);
  margin-bottom: 6px;
  text-align: center;
}
.preview-sub {
  font-size: 13px;
  color: #999;
  margin-bottom: 20px;
  text-align: center;
}

/* Preview card grid */
.preview-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  max-width: 700px;
  margin-bottom: 24px;
}

.preview-card {
  background: white;
  border-radius: 14px;
  width: 72px;
  height: 72px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 5px 16px rgba(0,0,0,0.1);
  font-size: 28px;
  color: var(--primary);
  border: 2px solid var(--primary-light);
  transition: transform 0.3s;
  animation: cardReveal 0.4s both;
}

@keyframes cardReveal {
  from { opacity: 0; transform: scale(0.7) rotateY(90deg); }
  to   { opacity: 1; transform: scale(1) rotateY(0deg); }
}

/* COUNTDOWN */
.countdown-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.countdown-num {
  font-size: 96px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1;
  animation: countPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
  text-shadow: 0 4px 20px rgba(155,123,255,0.4);
}

.countdown-label {
  font-size: 18px;
  font-weight: 600;
  color: var(--deep);
}

@keyframes countPop {
  from { transform: scale(0.3); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}

/* ===== GAME SCREEN ===== */
#screen-game {
  flex-direction: row;
  gap: 20px;
  padding: 14px 20px;
  align-items: flex-start;
  justify-content: center;
  overflow: hidden;
}

/* LEFT PANEL */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 190px;
  flex-shrink: 0;
  padding-top: 4px;
}

.panel-card {
  background: white;
  border-radius: 16px;
  padding: 14px 16px;
  box-shadow: 0 5px 18px rgba(0,0,0,0.08);
}

.panel-label {
  font-size: 10px;
  font-weight: 600;
  color: #aaa;
  text-transform: uppercase;
  letter-spacing: 0.7px;
  margin-bottom: 6px;
}

.panel-val {
  font-size: 28px;
  font-weight: 700;
  color: var(--deep);
  line-height: 1;
}

.panel-sub {
  font-size: 11px;
  color: #aaa;
  margin-top: 2px;
}

/* Circular timer */
.timer-wrap { position: relative; width: 76px; height: 76px; margin: 0 auto; }
.timer-svg  { transform: rotate(-90deg); width: 76px; height: 76px; }
.timer-bg   { fill: none; stroke: #e0d9ff; stroke-width: 7; }
.timer-fill { fill: none; stroke: url(#timerGrad); stroke-width: 7; stroke-linecap: round; transition: stroke-dashoffset 0.9s linear; }
.timer-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: var(--deep); }
.timer-text.urgent { color: #ff6b6b; animation: tPulse 0.5s infinite alternate; }
@keyframes tPulse { from { transform: scale(1); } to { transform: scale(1.1); } }

/* Found pairs mini grid */
.found-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 4px;
}

.found-cell {
  background: linear-gradient(135deg, #f3efff, #eae4ff);
  border-radius: 10px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  border: 2px solid var(--primary-light);
  animation: foundPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
}

@keyframes foundPop {
  from { transform: scale(0); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

/* RIGHT: CARD GRID */
.game-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  max-width: 680px;
}

.game-topbar {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
}

.diff-pill {
  padding: 3px 14px;
  border-radius: 50px;
  font-size: 11px;
  font-weight: 700;
  background: #f3efff;
  color: var(--primary);
}

.pairs-info {
  margin-left: auto;
  font-size: 13px;
  font-weight: 600;
  color: var(--deep);
}

/* THE CARD GRID */
.card-grid {
  display: grid;
  gap: 10px;
  justify-content: center;
}

/* CARD 3D FLIP */
.mem-card {
  width: 80px;
  height: 80px;
  perspective: 600px;
  cursor: pointer;
  flex-shrink: 0;
}

.mem-card.sm { width: 68px; height: 68px; }
.mem-card.xs { width: 58px; height: 58px; }

.card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 0.45s cubic-bezier(0.4, 0.2, 0.2, 1);
  border-radius: 14px;
}

.card-inner.sm { border-radius: 12px; }
.card-inner.xs { border-radius: 10px; }

.mem-card.flipped .card-inner,
.mem-card.matched .card-inner {
  transform: rotateY(180deg);
}

.card-face {
  position: absolute;
  inset: 0;
  border-radius: inherit;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* BACK face */
.card-back {
  background: linear-gradient(135deg, #9b7bff, #6a54ff);
  box-shadow: 0 6px 18px rgba(106,84,255,0.3);
}

.card-back-pattern {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.card-back-pattern::after {
  content: 'ConCiencia';
  font-family: 'Poppins', sans-serif;
  font-size: 9px;
  font-weight: 700;
  color: rgba(255,255,255,0.85);
  letter-spacing: 1px;
  writing-mode: vertical-lr;
  transform: rotate(180deg);
  white-space: nowrap;
}

/* FRONT face */
.card-front {
  background: white;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  transform: rotateY(180deg);
  font-size: 32px;
  border: 2px solid var(--primary-light);
  flex-direction: column;
  gap: 2px;
}

.card-front.sm { font-size: 26px; }
.card-front.xs { font-size: 22px; }

/* Matched glow */
.mem-card.matched .card-front {
  background: linear-gradient(135deg, #f0ebff, #e6e0ff);
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(155,123,255,0.3), 0 6px 18px rgba(155,123,255,0.2);
}

/* Wrong shake */
.mem-card.wrong .card-inner {
  animation: cardWrong 0.4s ease;
}
@keyframes cardWrong {
  0%,100% { transform: rotateY(180deg) translateX(0); }
  20%     { transform: rotateY(180deg) translateX(-6px); }
  40%     { transform: rotateY(180deg) translateX(6px); }
  60%     { transform: rotateY(180deg) translateX(-4px); }
  80%     { transform: rotateY(180deg) translateX(4px); }
}

/* ===== COUNTDOWN OVERLAY ===== */
#countdownOverlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(60,47,122,0.7);
  backdrop-filter: blur(6px);
  z-index: 500;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
}
#countdownOverlay.active { display: flex; }

.cd-num {
  font-size: 120px;
  font-weight: 700;
  color: white;
  text-shadow: 0 4px 30px rgba(155,123,255,0.8);
  line-height: 1;
  animation: cdPop 0.6s cubic-bezier(0.34,1.56,0.64,1) both;
}
@keyframes cdPop {
  from { transform: scale(0.2); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}

.cd-label {
  font-size: 20px;
  font-weight: 600;
  color: rgba(255,255,255,0.85);
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* ===== RESULT SCREEN ===== */
#screen-win { text-align: center; gap: 14px; }
.result-icon  { font-size: 68px; animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
.result-title { font-size: 36px; font-weight: 700; color: var(--deep); animation: fadeUp 0.5s 0.2s both; }
.result-sub   { color: #777; font-size: 14px; max-width: 380px; animation: fadeUp 0.5s 0.3s both; line-height: 1.6; }
.result-time  { font-size: 48px; font-weight: 700; color: var(--primary); animation: fadeUp 0.5s 0.4s both; line-height: 1; }
.result-time-label { font-size: 13px; color: #aaa; animation: fadeUp 0.5s 0.45s both; }
.result-btns  { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; animation: fadeUp 0.5s 0.55s both; }

.score-form { animation: fadeUp 0.5s 0.5s both; }
.score-form-label { font-size: 13px; color: #777; margin-bottom: 8px; }
.score-input-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.score-input {
  border: 2px solid #e0d9ff; border-radius: 50px; padding: 9px 16px;
  font-family: Poppins; font-size: 13px; outline: none; width: 190px;
  transition: 0.2s; text-align: center;
}
.score-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(155,123,255,0.15); }

/* ===== LOSE SCREEN ===== */
#screen-lose { text-align: center; gap: 14px; }

/* TOAST */
.toast {
  position: fixed; bottom: 18px; right: 18px;
  background: linear-gradient(90deg, #9b7bff, #6a54ff);
  color: white; padding: 12px 18px; border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18); opacity: 0;
  transform: translateY(16px); transition: 0.4s; z-index: 800;
  max-width: 270px; font-size: 13px; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }

/* ANIMATIONS */
@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn  { from { transform: scale(0.4); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* Shuffle wobble for preview cards */
@keyframes shuffleWobble {
  0%   { transform: translate(0,0) rotate(0deg); }
  20%  { transform: translate(-8px, 4px) rotate(-3deg); }
  40%  { transform: translate(6px, -5px) rotate(2deg); }
  60%  { transform: translate(-4px, 6px) rotate(-2deg); }
  80%  { transform: translate(5px, -3px) rotate(1deg); }
  100% { transform: translate(0,0) rotate(0deg); }
}
.preview-card.shuffle {
  animation: shuffleWobble 0.6s ease both !important;
}
</style>
</head>
<body>

<header>ConCiencia Emocional Digital</header>

<!-- ===== SELECT SCREEN ===== -->
<div class="screen active" id="screen-select">
  <button class="btn-back" onclick="window.location.href='minijuegos.html'">
    <i class="fa fa-arrow-left"></i> Minijuegos
  </button>
  <div class="screen-title">Memorama</div>
  <div class="screen-sub">Memoriza las cartas, encu√©ntralas y gana en el menor tiempo posible</div>

  <div class="diff-cards">
    <div class="diff-card easy" onclick="startFlow('easy')">
      <span class="diff-icon">üòä</span>
      <div class="diff-name">F√°cil</div>
      <div class="diff-info">8 pares (16 cartas)<br>Memorizaci√≥n: 1 seg<br>Sin l√≠mite de tiempo</div>
      <span class="diff-badge">Principiante</span>
    </div>
    <div class="diff-card medium" onclick="startFlow('medium')">
      <span class="diff-icon">ü§î</span>
      <div class="diff-name">Medio</div>
      <div class="diff-info">12 pares (24 cartas)<br>Memorizaci√≥n: 1 seg<br>3 minutos</div>
      <span class="diff-badge">Retador</span>
    </div>
    <div class="diff-card hard" onclick="startFlow('hard')">
      <span class="diff-icon">üî•</span>
      <div class="diff-name">Dif√≠cil</div>
      <div class="diff-info">18 pares (36 cartas)<br>Memorizaci√≥n: 1 seg<br>2 minutos</div>
      <span class="diff-badge">Experto</span>
    </div>
  </div>

  <div class="leaderboard-wrap">
    <div class="lb-title"><i class="fa fa-trophy" style="color:#ffd700"></i> Mejores tiempos</div>
    <div class="lb-tabs">
      <button class="lb-tab active" onclick="showLbTab('easy',this)">F√°cil</button>
      <button class="lb-tab" onclick="showLbTab('medium',this)">Medio</button>
      <button class="lb-tab" onclick="showLbTab('hard',this)">Dif√≠cil</button>
    </div>
    <ul class="lb-list" id="lbList"></ul>
  </div>
</div>

<!-- ===== PREVIEW SCREEN ===== -->
<div class="screen" id="screen-preview">
  <div class="preview-title" id="previewTitle">¬°Memoriza las cartas!</div>
  <div class="preview-sub" id="previewSub">Las cartas se voltear√°n en 5 segundos...</div>
  <div class="preview-grid" id="previewGrid"></div>
</div>

<!-- ===== COUNTDOWN OVERLAY ===== -->
<div id="countdownOverlay">
  <div class="cd-num" id="cdNum">3</div>
  <div class="cd-label" id="cdLabel">¬°Prep√°rate!</div>
</div>

<!-- ===== GAME SCREEN ===== -->
<div class="screen" id="screen-game">

  <!-- LEFT PANEL -->
  <div class="left-panel">
    <button class="btn-back" style="margin-bottom:0;" onclick="confirmQuit()">
      <i class="fa fa-arrow-left"></i> Salir
    </button>

    <div class="panel-card" style="text-align:center;">
      <div class="panel-label">Tiempo</div>
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 76 76">
          <defs>
            <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#9b7bff"/>
              <stop offset="100%" style="stop-color:#6a54ff"/>
            </linearGradient>
          </defs>
          <circle class="timer-bg"   cx="38" cy="38" r="31"/>
          <circle class="timer-fill" id="timerCircle" cx="38" cy="38" r="31"/>
        </svg>
        <div class="timer-text" id="timerText">‚àû</div>
      </div>
    </div>

    <div class="panel-card">
      <div class="panel-label">Intentos</div>
      <div class="panel-val" id="attemptsVal">0</div>
      <div class="panel-sub">intentos</div>
    </div>

    <div class="panel-card">
      <div class="panel-label">Pares encontrados</div>
      <div class="found-grid" id="foundGrid"></div>
      <div style="font-size:11px;color:#aaa;margin-top:8px;" id="foundCount">0 / 0</div>
    </div>
  </div>

  <!-- CENTER: CARD GRID -->
  <div class="game-center">
    <div class="game-topbar">
      <span class="diff-pill" id="diffPill">F√°cil</span>
      <span class="pairs-info" id="pairsInfo">0 / 8 pares</span>
    </div>
    <div class="card-grid" id="cardGrid"></div>
  </div>
</div>

<!-- ===== WIN SCREEN ===== -->
<div class="screen" id="screen-win">
  <div class="result-icon">üéâ</div>
  <div class="result-title">¬°Lo lograste!</div>
  <div class="result-sub" id="winMsg">Tu memoria es extraordinaria.</div>
  <div class="result-time" id="winTime">00:00</div>
  <div class="result-time-label">tiempo total</div>
  <div style="font-size:13px;color:#aaa;animation:fadeUp 0.5s 0.47s both;" id="winAttempts"></div>

  <div class="score-form" id="scoreForm">
    <div class="score-form-label">¬øGuardar tu tiempo en el top?</div>
    <div class="score-input-row">
      <input class="score-input" id="scoreNameInput" type="text" placeholder="Tu nombre..." maxlength="16">
      <button class="btn btn-primary" onclick="saveScore()"><i class="fa fa-check"></i> Guardar</button>
      <button class="btn btn-secondary" onclick="skipScore()"><i class="fa fa-forward"></i> Omitir</button>
    </div>
  </div>
  <div class="result-btns" id="winBtns" style="display:none;">
    <button class="btn btn-primary" onclick="retryGame()"><i class="fa fa-rotate-right"></i> Jugar de nuevo</button>
    <button class="btn btn-secondary" onclick="goMenu()"><i class="fa fa-home"></i> Men√∫</button>
  </div>
</div>

<!-- ===== LOSE SCREEN ===== -->
<div class="screen" id="screen-lose">
  <div class="result-icon">‚è∞</div>
  <div class="result-title">¬°Se acab√≥ el tiempo!</div>
  <div class="result-sub" id="loseMsg">No te rindas, ¬°tu memoria mejora con la pr√°ctica!</div>
  <div class="result-btns" style="margin-top:10px;">
    <button class="btn btn-primary" onclick="retryGame()"><i class="fa fa-rotate-right"></i> Volver a intentar</button>
    <button class="btn btn-secondary" onclick="goMenu()"><i class="fa fa-home"></i> Inicio</button>
  </div>
</div>

<footer>¬© 2026 ConCiencia ¬∑ Plataforma educativa emocional</footer>
<div class="toast" id="toast"></div>

<script>
/* =====================================================================
   ICON POOL ‚Äî Font Awesome icons (class names)
===================================================================== */
const ICON_POOL = [
  { icon: 'fa-solid fa-heart',          label: 'Coraz√≥n' },
  { icon: 'fa-solid fa-star',           label: 'Estrella' },
  { icon: 'fa-solid fa-moon',           label: 'Luna' },
  { icon: 'fa-solid fa-sun',            label: 'Sol' },
  { icon: 'fa-solid fa-cloud',          label: 'Nube' },
  { icon: 'fa-solid fa-bolt',           label: 'Rayo' },
  { icon: 'fa-solid fa-fire',           label: 'Fuego' },
  { icon: 'fa-solid fa-snowflake',      label: 'Copo' },
  { icon: 'fa-solid fa-leaf',           label: 'Hoja' },
  { icon: 'fa-solid fa-music',          label: 'M√∫sica' },
  { icon: 'fa-solid fa-camera',         label: 'C√°mara' },
  { icon: 'fa-solid fa-gem',            label: 'Gema' },
  { icon: 'fa-solid fa-crown',          label: 'Corona' },
  { icon: 'fa-solid fa-rocket',         label: 'Cohete' },
  { icon: 'fa-solid fa-rainbow',        label: 'Arco√≠ris' },
  { icon: 'fa-solid fa-dragon',         label: 'Drag√≥n' },
  { icon: 'fa-solid fa-globe',          label: 'Globo' },
  { icon: 'fa-solid fa-anchor',         label: 'Ancla' },
  { icon: 'fa-solid fa-feather',        label: 'Pluma' },
  { icon: 'fa-solid fa-horse',          label: 'Caballo' },
  { icon: 'fa-solid fa-cat',            label: 'Gato' },
  { icon: 'fa-solid fa-dog',            label: 'Perro' },
  { icon: 'fa-solid fa-fish',           label: 'Pez' },
  { icon: 'fa-solid fa-spider',         label: 'Ara√±a' },
  { icon: 'fa-solid fa-frog',           label: 'Rana' },
  { icon: 'fa-solid fa-otter',          label: 'Nutria' },
  { icon: 'fa-solid fa-kiwi-bird',      label: 'Kiwi' },
  { icon: 'fa-solid fa-dove',           label: 'Paloma' },
  { icon: 'fa-solid fa-seedling',       label: 'Brote' },
  { icon: 'fa-solid fa-tree',           label: '√Årbol' },
  { icon: 'fa-solid fa-mountain',       label: 'Monta√±a' },
  { icon: 'fa-solid fa-umbrella',       label: 'Paraguas' },
  { icon: 'fa-solid fa-ice-cream',      label: 'Helado' },
  { icon: 'fa-solid fa-pizza-slice',    label: 'Pizza' },
  { icon: 'fa-solid fa-cookie',         label: 'Galleta' },
  { icon: 'fa-solid fa-lemon',          label: 'Lim√≥n' },
];

/* =====================================================================
   DIFFICULTY CONFIG
===================================================================== */
const DIFF_CFG = {
  easy:   { label:'F√°cil',   pairs:8,  cols:4, time:0,   showSecs:1, cardClass:'',   cardPx:80 },
  medium: { label:'Medio',   pairs:12, cols:6, time:180, showSecs:1, cardClass:'sm', cardPx:68 },
  hard:   { label:'Dif√≠cil', pairs:18, cols:6, time:120, showSecs:1, cardClass:'xs', cardPx:58 },
};

const WIN_MSGS = [
  '¬°Tu memoria es extraordinaria! üß†',
  'Concentraci√≥n y calma: tu combinaci√≥n ganadora. üíú',
  '¬°Perfecto! Cada par encontrado es un logro.',
  'Eres una m√°quina de recordar. ¬°Impresionante!',
  'Tu mente trabaja de maravilla. ¬°Orgullo propio!',
];

const LOSE_MSGS = [
  'No te rindas, ¬°tu memoria mejora con la pr√°ctica!',
  'El tiempo vuela pero t√∫ puedes m√°s. ¬°Int√©ntalo!',
  'Casi casi... Un intento m√°s y lo tienes. üí™',
];

/* =====================================================================
   STATE
===================================================================== */
let currentDiff  = 'easy';
let cards        = [];     // [{id, iconIdx, flipped, matched, el}]
let flippedCards = [];     // max 2
let matchedPairs = 0;
let totalPairs   = 0;
let attempts     = 0;
let gameRunning  = false;
let canFlip      = false;
let timeLeft     = 0;
let totalTime    = 0;
let startTime    = 0;
let timerInt     = null;
let elapsed      = 0;
let currentLbTab = 'easy';
const CIRC       = 2 * Math.PI * 31;

/* =====================================================================
   FLOW: SELECT ‚Üí PREVIEW ‚Üí COUNTDOWN ‚Üí GAME
===================================================================== */
function startFlow(diff) {
  currentDiff  = diff;
  const cfg    = DIFF_CFG[diff];
  totalPairs   = cfg.pairs;
  matchedPairs = 0;
  attempts     = 0;
  flippedCards = [];
  canFlip      = false;
  gameRunning  = false;

  // Build card data
  const pool = shuffle([...ICON_POOL]).slice(0, cfg.pairs);
  const doubled = shuffle([...pool, ...pool].map((icon, i) => ({
    id: i,
    iconIdx: ICON_POOL.indexOf(icon),
    icon: icon.icon,
    label: icon.label,
    flipped: false,
    matched: false,
    el: null,
  })));
  cards = doubled;

  buildPreview(pool, cfg);
}

/* =====================================================================
   PREVIEW SCREEN
===================================================================== */
function buildPreview(pool, cfg) {
  showScreen('screen-preview');
  document.getElementById('previewTitle').textContent = '¬°Memoriza las cartas!';
  document.getElementById('previewSub').textContent   = `¬°Memor√≠zalas! Se voltean en ${cfg.showSecs} segundo...`;

  const grid = document.getElementById('previewGrid');
  grid.innerHTML = '';

  pool.forEach((icon, i) => {
    const card = document.createElement('div');
    card.className = 'preview-card';
    card.style.animationDelay = (i * 0.05) + 's';
    card.innerHTML = `<i class="${icon.icon}" style="color:var(--primary);font-size:28px;"></i>`;
    grid.appendChild(card);
  });

  // Shuffle animation after 1s
  setTimeout(() => {
    const cards = grid.querySelectorAll('.preview-card');
    cards.forEach((c, i) => {
      c.classList.add('shuffle');
      c.style.animationDelay = (i * 0.04) + 's';
    });
    // Remove shuffle class after animation
    setTimeout(() => {
      cards.forEach(c => {
        c.classList.remove('shuffle');
        c.style.animationDelay = '';
      });
    }, 800);
  }, 900);

  // Wait then countdown
  setTimeout(() => {
    runCountdown(cfg);
  }, cfg.showSecs * 1000);
}

/* =====================================================================
   COUNTDOWN OVERLAY
===================================================================== */
function runCountdown(cfg) {
  // Build game in background
  buildGameScreen(cfg);

  const overlay = document.getElementById('countdownOverlay');
  const numEl   = document.getElementById('cdNum');
  const lblEl   = document.getElementById('cdLabel');
  overlay.classList.add('active');

  const steps = [
    { num: '3', label: '¬°Prep√°rate!' },
    { num: '2', label: '¬°Conc√©ntrate!' },
    { num: '1', label: '¬°Ya casi!' },
    { num: '¬°YA!', label: 'A encontrar los pares' },
  ];

  let i = 0;
  function nextStep() {
    if (i >= steps.length) {
      overlay.classList.remove('active');
      showScreen('screen-game');
      startGameTimer(cfg);
      canFlip = true;
      gameRunning = true;
      startTime = Date.now();
      return;
    }
    const s = steps[i++];
    numEl.textContent = s.num;
    lblEl.textContent = s.label;
    // Re-trigger animation
    numEl.style.animation = 'none';
    void numEl.offsetWidth;
    numEl.style.animation = 'cdPop 0.6s cubic-bezier(0.34,1.56,0.64,1) both';
    setTimeout(nextStep, 900);
  }
  nextStep();
}

/* =====================================================================
   BUILD GAME SCREEN
===================================================================== */
function buildGameScreen(cfg) {
  document.getElementById('diffPill').textContent  = cfg.label;
  document.getElementById('pairsInfo').textContent = `0 / ${totalPairs} pares`;
  document.getElementById('attemptsVal').textContent = '0';
  document.getElementById('foundCount').textContent  = `0 / ${totalPairs}`;
  document.getElementById('foundGrid').innerHTML     = '';

  // Timer display
  if (cfg.time === 0) {
    document.getElementById('timerText').textContent = '‚àû';
    document.getElementById('timerCircle').style.strokeDasharray  = CIRC;
    document.getElementById('timerCircle').style.strokeDashoffset = 0;
    document.getElementById('timerCircle').style.stroke = 'url(#timerGrad)';
  }

  // Card grid
  const gridEl = document.getElementById('cardGrid');
  gridEl.innerHTML = '';
  gridEl.style.gridTemplateColumns = `repeat(${cfg.cols}, ${cfg.cardPx}px)`;

  cards.forEach((card, idx) => {
    const div = document.createElement('div');
    div.className = `mem-card ${cfg.cardClass}`;
    div.innerHTML = `
      <div class="card-inner ${cfg.cardClass}">
        <div class="card-face card-back">
          <div class="card-back-pattern"></div>
        </div>
        <div class="card-face card-front ${cfg.cardClass}">
          <i class="${card.icon}"></i>
        </div>
      </div>`;
    div.addEventListener('click', () => onCardClick(idx));
    card.el = div;
    gridEl.appendChild(div);
  });
}

/* =====================================================================
   CARD CLICK
===================================================================== */
function onCardClick(idx) {
  if (!canFlip || !gameRunning) return;
  const card = cards[idx];
  if (card.flipped || card.matched) return;
  if (flippedCards.length >= 2) return;

  // Flip
  card.flipped = true;
  card.el.classList.add('flipped');
  flippedCards.push(card);

  if (flippedCards.length === 2) {
    attempts++;
    document.getElementById('attemptsVal').textContent = attempts;
    canFlip = false;

    const [a, b] = flippedCards;
    if (a.icon === b.icon) {
      // MATCH
      setTimeout(() => {
        a.matched = b.matched = true;
        a.el.classList.add('matched');
        b.el.classList.add('matched');
        flippedCards = [];
        canFlip = true;
        matchedPairs++;
        addFoundPair(a);
        updatePairsHUD();
        showToast(matchMsgs[randInt(0, matchMsgs.length - 1)]);

        if (matchedPairs === totalPairs) {
          endGame(true);
        }
      }, 400);
    } else {
      // NO MATCH
      a.el.classList.add('wrong');
      b.el.classList.add('wrong');
      setTimeout(() => {
        a.el.classList.remove('wrong');
        b.el.classList.remove('wrong');
        a.flipped = b.flipped = false;
        a.el.classList.remove('flipped');
        b.el.classList.remove('flipped');
        flippedCards = [];
        canFlip = true;
      }, 900);
    }
  }
}

const matchMsgs = ['¬°Par encontrado! üíú','¬°Excelente memoria!','¬°Eso es!','¬°Brillante!','¬°Perfecto!'];

/* =====================================================================
   FOUND PAIRS PANEL
===================================================================== */
function addFoundPair(card) {
  const grid = document.getElementById('foundGrid');
  const cell = document.createElement('div');
  cell.className = 'found-cell';
  cell.innerHTML = `<i class="${card.icon}" style="color:var(--primary)"></i>`;
  grid.appendChild(cell);
  document.getElementById('foundCount').textContent = `${matchedPairs} / ${totalPairs}`;
}

function updatePairsHUD() {
  document.getElementById('pairsInfo').textContent = `${matchedPairs} / ${totalPairs} pares`;
}

/* =====================================================================
   TIMER
===================================================================== */
function startGameTimer(cfg) {
  stopTimer();
  timeLeft  = cfg.time;
  totalTime = cfg.time;

  if (cfg.time === 0) {
    // Infinite ‚Äî just count up elapsed shown in timer text
    timerInt = setInterval(() => {
      elapsed = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(elapsed / 60);
      const s = elapsed % 60;
      document.getElementById('timerText').textContent = `${m}:${String(s).padStart(2,'0')}`;
    }, 1000);
    return;
  }

  updateTimerUI();
  timerInt = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    if (timeLeft <= 0) {
      stopTimer();
      gameRunning = false;
      endGame(false);
    }
  }, 1000);
}

function stopTimer() {
  if (timerInt) { clearInterval(timerInt); timerInt = null; }
}

function updateTimerUI() {
  const circle = document.getElementById('timerCircle');
  const text   = document.getElementById('timerText');
  const pct    = timeLeft / totalTime;
  const offset = CIRC * (1 - pct);
  circle.style.strokeDasharray  = CIRC;
  circle.style.strokeDashoffset = offset;

  const mins = Math.floor(timeLeft / 60);
  const secs = timeLeft % 60;
  text.textContent = `${mins}:${String(secs).padStart(2,'0')}`;

  if (pct > 0.5) {
    circle.style.stroke = 'url(#timerGrad)';
    text.className = 'timer-text';
  } else if (pct > 0.25) {
    circle.style.stroke = '#ffc844';
    text.className = 'timer-text';
  } else {
    circle.style.stroke = '#ff6b6b';
    text.className = 'timer-text urgent';
  }
}

/* =====================================================================
   END GAME
===================================================================== */
function endGame(won) {
  stopTimer();
  gameRunning = false;
  canFlip = false;

  elapsed = Math.floor((Date.now() - startTime) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  const timeStr = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;

  if (won) {
    document.getElementById('winTime').textContent     = timeStr;
    document.getElementById('winMsg').textContent      = WIN_MSGS[randInt(0, WIN_MSGS.length-1)];
    document.getElementById('winAttempts').textContent = `${attempts} intentos ¬∑ ${matchedPairs} pares`;
    document.getElementById('scoreNameInput').value    = '';
    document.getElementById('scoreForm').style.display = '';
    document.getElementById('winBtns').style.display   = 'none';
    showScreen('screen-win');
  } else {
    document.getElementById('loseMsg').textContent = LOSE_MSGS[randInt(0, LOSE_MSGS.length-1)];
    showScreen('screen-lose');
  }
}

function confirmQuit() {
  stopTimer();
  gameRunning = false;
  goMenu();
}

function retryGame() { startFlow(currentDiff); }
function goMenu() { showScreen('screen-select'); renderLeaderboard(); }

/* =====================================================================
   SCORE SAVE
===================================================================== */
function saveScore() {
  const name = document.getElementById('scoreNameInput').value.trim();
  if (!name) { showToast('Escribe tu nombre primero üòä'); return; }

  const key  = `mem_scores_${currentDiff}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  list.push({ name, time: elapsed, attempts, diff: currentDiff });
  list.sort((a, b) => a.time - b.time);
  if (list.length > 10) list.splice(10);
  localStorage.setItem(key, JSON.stringify(list));

  document.getElementById('scoreForm').style.display = 'none';
  document.getElementById('winBtns').style.display   = 'flex';
  showToast('¬°Tiempo guardado! üèÜ');
  renderLeaderboard();
}

function skipScore() {
  document.getElementById('scoreForm').style.display = 'none';
  document.getElementById('winBtns').style.display   = 'flex';
}

/* =====================================================================
   LEADERBOARD
===================================================================== */
function showLbTab(diff, btn) {
  currentLbTab = diff;
  document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const key  = `mem_scores_${currentLbTab}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  const ul   = document.getElementById('lbList');
  ul.innerHTML = '';

  if (!list.length) {
    ul.innerHTML = '<li class="lb-empty">A√∫n no hay registros. ¬°S√© el primero!</li>';
    return;
  }

  list.forEach((entry, i) => {
    const mins = Math.floor(entry.time / 60);
    const secs = entry.time % 60;
    const ts   = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i+1}`;
    ul.innerHTML += `
      <li class="lb-row">
        <span class="lb-pos">${medal}</span>
        <span class="lb-name">${escHtml(entry.name)}</span>
        <span class="lb-time">${ts} ¬∑ ${entry.attempts} int.</span>
      </li>`;
  });
}

/* =====================================================================
   UTILS
===================================================================== */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = randInt(0, i);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

/* BOOT */
renderLeaderboard();
</script>
</body>
</html>
