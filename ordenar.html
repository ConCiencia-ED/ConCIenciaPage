<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ConCiencia ¬∑ Ordenar los Aros</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%239b7bff' d='M12 21s-8-6.58-8-11.5S7.58 2 12 7.09 20 2 20 9.5 12 21 12 21z'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --primary: #9b7bff;
  --primary2: #6a54ff;
  --primary-light: #c8b6ff;
  --bg: #f6f3ff;
  --bg2: #efeaff;
  --card: #ffffff;
  --text: #2d2d2d;
  --deep: #3c2f7a;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }

body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, var(--bg), var(--bg2));
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  background: linear-gradient(90deg, #8f6fff, #6a54ff);
  color: white;
  padding: 14px 20px;
  text-align: center;
  font-weight: 600;
  font-size: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.12);
  flex-shrink: 0;
}
footer { text-align: center; padding: 8px; font-size: 12px; color: #999; flex-shrink: 0; }

/* ===== SCREENS ===== */
.screen { display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.screen.active { display: flex; }

/* ===== BUTTONS ===== */
.btn {
  padding: 11px 26px; border-radius: 50px; border: none;
  font-family: Poppins; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
  transition: transform 0.2s, box-shadow 0.2s; white-space: nowrap;
}
.btn:hover  { transform: scale(1.05); }
.btn:active { transform: scale(0.97); }
.btn-primary   { background: linear-gradient(90deg, #9b7bff, #6a54ff); color: white; box-shadow: 0 5px 18px rgba(106,84,255,0.32); }
.btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
.btn-back {
  align-self: flex-start; background: none; border: 2px solid var(--primary);
  color: var(--primary); padding: 7px 16px; border-radius: 50px; cursor: pointer;
  font-family: Poppins; font-size: 12px; font-weight: 600; margin-bottom: 18px;
  transition: 0.3s; display: flex; align-items: center; gap: 6px;
}
.btn-back:hover { background: var(--primary); color: white; }

/* ===== SELECT SCREEN ===== */
.screen-title { font-size: 38px; font-weight: 700; color: var(--deep); margin-bottom: 6px; animation: fadeUp 0.7s both; }
.screen-sub   { color: #777; margin-bottom: 28px; font-size: 14px; animation: fadeUp 0.9s both; text-align: center; max-width: 460px; }

.diff-cards { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; animation: fadeUp 1.1s both; }
.diff-card {
  background: white; border-radius: 22px; width: 195px; padding: 26px 18px 22px;
  text-align: center; cursor: pointer; box-shadow: 0 8px 26px rgba(0,0,0,0.09);
  transition: 0.3s; border: 3px solid transparent;
}
.diff-card:hover { transform: translateY(-9px) scale(1.03); box-shadow: 0 20px 40px rgba(0,0,0,0.14); }
.diff-card.easy:hover   { border-color: #7be0ad; }
.diff-card.medium:hover { border-color: #ffc844; }
.diff-card.hard:hover   { border-color: #ff6b6b; }
.diff-icon { font-size: 40px; margin-bottom: 12px; display: block; }
.diff-name { font-size: 18px; font-weight: 700; color: var(--deep); margin-bottom: 6px; }
.diff-info { font-size: 11px; color: #999; line-height: 1.8; }
.diff-badge { display: inline-block; padding: 3px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; margin-top: 10px; }
.easy   .diff-badge { background: #e6faf2; color: #2ecc71; }
.medium .diff-badge { background: #fff8e6; color: #f39c12; }
.hard   .diff-badge { background: #ffe6e6; color: #e74c3c; }

/* LEADERBOARD */
.leaderboard-wrap {
  margin-top: 28px; background: white; border-radius: 18px; padding: 18px 22px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08); width: 100%; max-width: 520px; animation: fadeUp 1.3s both;
}
.lb-title  { font-weight: 700; color: var(--deep); font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 7px; }
.lb-tabs   { display: flex; gap: 6px; margin-bottom: 12px; }
.lb-tab    { padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; cursor: pointer; border: 2px solid #e0d9ff; background: white; color: #999; transition: 0.2s; }
.lb-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
.lb-list   { list-style: none; }
.lb-row    { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid #f3efff; font-size: 13px; }
.lb-row:last-child { border-bottom: none; }
.lb-pos    { font-weight: 700; color: var(--primary-light); width: 24px; text-align: center; font-size: 14px; }
.lb-name   { flex: 1; font-weight: 600; color: var(--deep); }
.lb-score  { font-weight: 700; color: var(--primary); font-size: 12px; }
.lb-empty  { text-align: center; color: #bbb; font-size: 12px; padding: 10px 0; }

/* ===== GAME SCREEN ===== */
#screen-game {
  flex-direction: row;
  gap: 20px;
  padding: 12px 20px;
  align-items: stretch;
  justify-content: center;
  overflow: hidden;
}

/* LEFT PANEL */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 180px;
  flex-shrink: 0;
  padding-top: 4px;
}

.panel-card {
  background: white;
  border-radius: 16px;
  padding: 14px 16px;
  box-shadow: 0 5px 18px rgba(0,0,0,0.08);
}
.panel-label {
  font-size: 10px; font-weight: 600; color: #aaa;
  text-transform: uppercase; letter-spacing: 0.7px; margin-bottom: 6px;
}
.panel-val  { font-size: 28px; font-weight: 700; color: var(--deep); line-height: 1; }
.panel-sub  { font-size: 11px; color: #aaa; margin-top: 2px; }

/* Timer */
.timer-wrap { position: relative; width: 76px; height: 76px; margin: 0 auto; }
.timer-svg  { transform: rotate(-90deg); width: 76px; height: 76px; }
.timer-bg   { fill: none; stroke: #e0d9ff; stroke-width: 7; }
.timer-fill { fill: none; stroke: url(#timerGrad); stroke-width: 7; stroke-linecap: round; transition: stroke-dashoffset 0.9s linear; }
.timer-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: var(--deep); }
.timer-text.urgent { color: #ff6b6b; animation: tPulse 0.5s infinite alternate; }
@keyframes tPulse { from{transform:scale(1);}to{transform:scale(1.1);} }

.btn-game {
  width: 100%; padding: 11px 14px; border-radius: 12px; border: none;
  font-family: Poppins; font-size: 12px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 7px;
  transition: 0.2s;
}
.btn-game:hover { transform: scale(1.03); }
.btn-game.secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
.btn-game.danger    { background: white; color: #ff6b6b; border: 2px solid #ff6b6b; }
.btn-game.danger:hover { background: #ff6b6b; color: white; }
.btn-game.warning   { background: white; color: #f39c12; border: 2px solid #f39c12; }
.btn-game.warning:hover { background: #f39c12; color: white; }

/* ===== GAME CENTER ===== */
.game-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  max-width: 800px;
}

.game-topbar {
  display: flex; align-items: center; gap: 10px; width: 100%;
}
.diff-pill {
  padding: 3px 14px; border-radius: 50px; font-size: 11px; font-weight: 700;
  background: #f3efff; color: var(--primary);
}
.moves-info { margin-left: auto; font-size: 13px; font-weight: 600; color: var(--deep); }

/* ===== TUBES AREA ===== */
.tubes-area {
  display: flex;
  gap: 18px;
  align-items: flex-end;
  justify-content: center;
  flex: 1;
  padding: 10px 0 20px;
  flex-wrap: wrap;
}

/* ===== TUBE ===== */
.tube-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  cursor: pointer;
  transition: transform 0.15s;
  position: relative;
}
.tube-wrap:hover { transform: translateY(-4px); }
.tube-wrap.selected { transform: translateY(-12px); }
.tube-wrap.selected .pole { box-shadow: 0 0 0 3px rgba(155,123,255,0.5); }
.tube-wrap.cant-drop { animation: tubeShake 0.35s ease; }
.tube-wrap.done .pole { box-shadow: 0 0 0 3px #7be0ad, 0 4px 16px rgba(123,224,173,0.4); }

@keyframes tubeShake {
  0%,100%{transform:translateX(0);}
  20%{transform:translateX(-7px);}
  40%{transform:translateX(7px);}
  60%{transform:translateX(-5px);}
  80%{transform:translateX(5px);}
}

/* The vertical pole */
.pole {
  width: 10px;
  border-radius: 5px;
  background: linear-gradient(180deg, #b0a8d0 0%, #8a82b8 50%, #6e66a0 100%);
  box-shadow: inset -2px 0 4px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.12);
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  z-index: 0;
  top: 0;
  bottom: 18px;
}

/* Pole base */
.pole-base {
  width: 52px;
  height: 10px;
  background: linear-gradient(180deg, #9b8fd0 0%, #7a6eb8 100%);
  border-radius: 5px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  margin-top: 2px;
  position: relative;
  z-index: 1;
}

/* Pole top cap */
.pole-cap {
  width: 14px;
  height: 14px;
  background: linear-gradient(135deg, #c8b6ff, #9b7bff);
  border-radius: 50%;
  margin-bottom: -2px;
  position: relative;
  z-index: 2;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* Rings stack area */
.rings-stack {
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  position: relative;
  z-index: 1;
  gap: 2px;
  padding-top: 4px;
}

.tube-label {
  font-size: 10px;
  font-weight: 600;
  color: #aaa;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-top: 6px;
  position: relative;
  z-index: 2;
}

/* ===== RING ===== */
.ring {
  width: 100%;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: transform 0.18s cubic-bezier(0.34,1.56,0.64,1);
  z-index: 1;
}

.ring-svg {
  display: block;
  filter: drop-shadow(0 3px 5px rgba(0,0,0,0.18));
  transition: filter 0.15s;
}

.tube-wrap.selected .rings-stack .ring:last-child .ring-svg {
  filter: drop-shadow(0 6px 14px rgba(155,123,255,0.6)) brightness(1.12);
}

/* Fake-move animation for locked rings */
@keyframes ringFakeMove {
  0%  { transform: translateY(0); }
  25% { transform: translateY(-12px); }
  55% { transform: translateY(-7px); }
  80% { transform: translateY(-12px); }
  100%{ transform: translateY(0); }
}
.ring.fake-move {
  animation: ringFakeMove 0.5s ease;
}

/* ===== WIN / LOSE ===== */
#screen-win, #screen-lose { text-align: center; gap: 14px; }
.result-icon  { font-size: 68px; animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
.result-title { font-size: 36px; font-weight: 700; color: var(--deep); animation: fadeUp 0.5s 0.2s both; }
.result-sub   { color: #777; font-size: 14px; max-width: 380px; line-height: 1.6; animation: fadeUp 0.5s 0.3s both; }
.result-moves { font-size: 48px; font-weight: 700; color: var(--primary); animation: fadeUp 0.5s 0.4s both; line-height: 1; }
.result-moves-label { font-size: 13px; color: #aaa; animation: fadeUp 0.5s 0.45s both; }
.result-btns  { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; animation: fadeUp 0.5s 0.55s both; }

.score-form { animation: fadeUp 0.5s 0.5s both; }
.score-form-label { font-size: 13px; color: #777; margin-bottom: 8px; }
.score-input-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.score-input {
  border: 2px solid #e0d9ff; border-radius: 50px; padding: 9px 16px;
  font-family: Poppins; font-size: 13px; outline: none; width: 190px;
  transition: 0.2s; text-align: center;
}
.score-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(155,123,255,0.15); }

/* TOAST */
.toast {
  position: fixed; bottom: 18px; right: 18px;
  background: linear-gradient(90deg, #9b7bff, #6a54ff);
  color: white; padding: 12px 18px; border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18); opacity: 0;
  transform: translateY(16px); transition: 0.4s; z-index: 800;
  max-width: 270px; font-size: 13px; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }

@keyframes fadeUp { from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);} }
@keyframes popIn  { from{transform:scale(0.4);opacity:0;}to{transform:scale(1);opacity:1;} }
</style>
</head>
<body>

<header>ConCiencia Emocional Digital</header>

<!-- ===== SELECT ===== -->
<div class="screen active" id="screen-select">
  <button class="btn-back" onclick="window.location.href='minijuegos.html'">
    <i class="fa fa-arrow-left"></i> Minijuegos
  </button>
  <div class="screen-title">Ordenar los Aros</div>
  <div class="screen-sub">Mueve los aros entre los palos hasta que cada uno tenga un solo color. Solo puedes mover el aro de arriba, y puedes ponerlo en cualquier palo con espacio.</div>

  <div class="diff-cards">
    <div class="diff-card easy" onclick="startGame('easy')">
      <span class="diff-icon">üòä</span>
      <div class="diff-name">F√°cil</div>
      <div class="diff-info">3 colores ¬∑ 5 tubos<br>4 aros por tubo<br>Sin l√≠mite de tiempo</div>
      <span class="diff-badge">Principiante</span>
    </div>
    <div class="diff-card medium" onclick="startGame('medium')">
      <span class="diff-icon">ü§î</span>
      <div class="diff-name">Medio</div>
      <div class="diff-info">5 colores ¬∑ 7 tubos<br>4 aros por tubo<br>5 minutos</div>
      <span class="diff-badge">Retador</span>
    </div>
    <div class="diff-card hard" onclick="startGame('hard')">
      <span class="diff-icon">üî•</span>
      <div class="diff-name">Dif√≠cil</div>
      <div class="diff-info">7 colores ¬∑ 9 tubos<br>4 aros por tubo<br>4 minutos</div>
      <span class="diff-badge">Experto</span>
    </div>
  </div>

  <div class="leaderboard-wrap">
    <div class="lb-title"><i class="fa fa-trophy" style="color:#ffd700"></i> Mejores puntajes</div>
    <div class="lb-tabs">
      <button class="lb-tab active" onclick="showLbTab('easy',this)">F√°cil</button>
      <button class="lb-tab" onclick="showLbTab('medium',this)">Medio</button>
      <button class="lb-tab" onclick="showLbTab('hard',this)">Dif√≠cil</button>
    </div>
    <ul class="lb-list" id="lbList"></ul>
  </div>
</div>

<!-- ===== GAME ===== -->
<div class="screen" id="screen-game">

  <div class="left-panel">
    <button class="btn-back" style="margin-bottom:0" onclick="confirmQuit()">
      <i class="fa fa-arrow-left"></i> Salir
    </button>

    <div class="panel-card" style="text-align:center;">
      <div class="panel-label">Tiempo</div>
      <div class="timer-wrap">
        <svg class="timer-svg" viewBox="0 0 76 76">
          <defs>
            <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#9b7bff"/>
              <stop offset="100%" style="stop-color:#6a54ff"/>
            </linearGradient>
          </defs>
          <circle class="timer-bg"   cx="38" cy="38" r="31"/>
          <circle class="timer-fill" id="timerCircle" cx="38" cy="38" r="31"/>
        </svg>
        <div class="timer-text" id="timerText">‚àû</div>
      </div>
    </div>

    <div class="panel-card">
      <div class="panel-label">Movimientos</div>
      <div class="panel-val" id="movesVal">0</div>
      <div class="panel-sub">movimientos</div>
    </div>

    <div class="panel-card">
      <div class="panel-label">Tubos listos</div>
      <div class="panel-val" id="doneVal">0</div>
      <div class="panel-sub" id="doneSub">de 0</div>
    </div>

    <button class="btn-game warning" onclick="undoMove()">
      <i class="fa fa-rotate-left"></i> Deshacer
    </button>
    <button class="btn-game secondary" onclick="resetGame()">
      <i class="fa fa-arrows-rotate"></i> Reiniciar
    </button>
    <button class="btn-game danger" onclick="confirmQuit()">
      <i class="fa fa-flag"></i> Salir
    </button>
  </div>

  <div class="game-center">
    <div class="game-topbar">
      <span class="diff-pill" id="diffPill">F√°cil</span>
      <span class="moves-info" id="movesInfo">0 movimientos</span>
    </div>
    <div class="tubes-area" id="tubesArea"></div>
  </div>
</div>

<!-- ===== WIN ===== -->
<div class="screen" id="screen-win">
  <div class="result-icon">üéâ</div>
  <div class="result-title">¬°Resuelto!</div>
  <div class="result-sub" id="winMsg">Tu l√≥gica y paciencia son admirables.</div>
  <div class="result-moves" id="winMoves">0</div>
  <div class="result-moves-label">movimientos</div>

  <div class="score-form" id="scoreForm">
    <div class="score-form-label">¬øGuardar tu resultado en el top?</div>
    <div class="score-input-row">
      <input class="score-input" id="scoreNameInput" type="text" placeholder="Tu nombre..." maxlength="16">
      <button class="btn btn-primary" onclick="saveScore()"><i class="fa fa-check"></i> Guardar</button>
      <button class="btn btn-secondary" onclick="skipScore()"><i class="fa fa-forward"></i> Omitir</button>
    </div>
  </div>
  <div class="result-btns" id="winBtns" style="display:none;">
    <button class="btn btn-primary"   onclick="retryGame()"><i class="fa fa-rotate-right"></i> Jugar de nuevo</button>
    <button class="btn btn-secondary" onclick="goMenu()"><i class="fa fa-home"></i> Men√∫</button>
  </div>
</div>

<!-- ===== LOSE ===== -->
<div class="screen" id="screen-lose">
  <div class="result-icon">‚è∞</div>
  <div class="result-title">¬°Se acab√≥ el tiempo!</div>
  <div class="result-sub" id="loseMsg">No te rindas. La paciencia se entrena. ¬°Int√©ntalo de nuevo!</div>
  <div class="result-btns" style="margin-top:10px;">
    <button class="btn btn-primary"   onclick="retryGame()"><i class="fa fa-rotate-right"></i> Volver a intentar</button>
    <button class="btn btn-secondary" onclick="goMenu()"><i class="fa fa-home"></i> Inicio</button>
  </div>
</div>

<footer>¬© 2026 ConCiencia ¬∑ Plataforma educativa emocional</footer>
<div class="toast" id="toast"></div>

<script>
/* =====================================================================
   COLOR PALETTES ‚Äî all ConCiencia purples + complementary shades
===================================================================== */
const COLOR_PALETTES = {
  3: [
    { fill: '#9b7bff', stroke: '#7a5cff', label: 'Lavanda', symbol: '‚òÖ' },
    { fill: '#c8b6ff', stroke: '#a99be0', label: 'Lila',    symbol: '‚óè' },
    { fill: '#6a54ff', stroke: '#4e3ed4', label: '√çndigo',  symbol: '‚ñ≤' },
  ],
  5: [
    { fill: '#9b7bff', stroke: '#7a5cff', label: 'Lavanda', symbol: '‚òÖ' },
    { fill: '#c8b6ff', stroke: '#a99be0', label: 'Lila',    symbol: '‚óè' },
    { fill: '#6a54ff', stroke: '#4e3ed4', label: '√çndigo',  symbol: '‚ñ≤' },
    { fill: '#b39dff', stroke: '#9278e8', label: 'Orqu√≠dea',symbol: '‚ô¶' },
    { fill: '#7b66ff', stroke: '#5a4ce0', label: 'Violeta', symbol: '‚úö' },
  ],
  7: [
    { fill: '#9b7bff', stroke: '#7a5cff', label: 'Lavanda', symbol: '‚òÖ' },
    { fill: '#c8b6ff', stroke: '#a99be0', label: 'Lila',    symbol: '‚óè' },
    { fill: '#6a54ff', stroke: '#4e3ed4', label: '√çndigo',  symbol: '‚ñ≤' },
    { fill: '#b39dff', stroke: '#9278e8', label: 'Orqu√≠dea',symbol: '‚ô¶' },
    { fill: '#7b66ff', stroke: '#5a4ce0', label: 'Violeta', symbol: '‚úö' },
    { fill: '#d4c5ff', stroke: '#b39dff', label: 'Malva',   symbol: '‚ñ†' },
    { fill: '#5241cc', stroke: '#3b2daa', label: 'Zafiro',  symbol: '‚ô•' },
  ],
};

/* =====================================================================
   DIFFICULTY CONFIG
===================================================================== */
const DIFF_CFG = {
  easy:   { label:'F√°cil',   colors:3, tubes:5, ringsPerTube:4, extraEmpty:2, time:0   },
  medium: { label:'Medio',   colors:5, tubes:7, ringsPerTube:4, extraEmpty:2, time:300 },
  hard:   { label:'Dif√≠cil', colors:7, tubes:9, ringsPerTube:4, extraEmpty:2, time:240 },
};

const WIN_MSGS  = [
  '¬°Tu l√≥gica y paciencia son admirables! üíú',
  'Cada movimiento cont√≥. ¬°Extraordinario!',
  'Mente ordenada, vida ordenada. ¬°Perfecto!',
  '¬°Resolviste el rompecabezas con elegancia!',
  '¬°Imparable! Tu concentraci√≥n es poderosa.',
];
const LOSE_MSGS = [
  'No te rindas. La paciencia se entrena. üíú',
  'El tiempo vuela, pero tu mente puede m√°s.',
  '¬°Casi! Un intento m√°s y lo logras.',
];

/* =====================================================================
   STATE
===================================================================== */
let currentDiff  = 'easy';
let tubes        = [];     // array of arrays of colorIdx (bottom=index 0)
let selectedTube = null;   // index of selected tube
let moves        = 0;
let doneTubes    = 0;
let totalColors  = 0;
let gameRunning  = false;
let timeLeft     = 0;
let totalTime    = 0;
let timerInt     = null;
let elapsed      = 0;
let startTime    = 0;
let history      = [];     // for undo: array of deep-copied tube states
let currentLbTab = 'easy';
let isAnimating  = false;
const CIRC       = 2 * Math.PI * 31;
const RINGS_PER  = 4;      // always 4 rings per tube

/* =====================================================================
   START GAME
===================================================================== */
function startGame(diff) {
  currentDiff  = diff;
  const cfg    = DIFF_CFG[diff];
  totalColors  = cfg.colors;
  moves        = 0;
  doneTubes    = 0;
  selectedTube = null;
  history      = [];
  gameRunning  = true;

  tubes = generatePuzzle(cfg);

  showScreen('screen-game');
  document.getElementById('diffPill').textContent  = cfg.label;
  document.getElementById('movesVal').textContent  = '0';
  document.getElementById('movesInfo').textContent = '0 movimientos';
  document.getElementById('doneVal').textContent   = '0';
  document.getElementById('doneSub').textContent   = `de ${cfg.colors}`;

  renderTubes();
  startTimer(cfg);
}

function retryGame() { startGame(currentDiff); }
function goMenu()    { showScreen('screen-select'); renderLeaderboard(); }
function confirmQuit() { stopTimer(); gameRunning = false; goMenu(); }

/* =====================================================================
   PUZZLE GENERATION ‚Äî shuffle rings so solution requires moves
===================================================================== */
function generatePuzzle(cfg) {
  const { colors, tubes: numTubes, ringsPerTube, extraEmpty } = cfg;
  const colorTubes = numTubes - extraEmpty; // tubes that have rings

  // Create solved state: each color tube filled with one color
  let state = [];
  for (let c = 0; c < colorTubes; c++) {
    state.push(Array(ringsPerTube).fill(c));
  }
  // Add empty tubes
  for (let e = 0; e < extraEmpty; e++) {
    state.push([]);
  }

  // Shuffle by doing random valid reverse-moves many times
  for (let i = 0; i < 400; i++) {
    const filled = state.map((t, i) => ({ t, i })).filter(x => x.t.length > 0);
    const hasRoom = state.map((t, i) => ({ t, i })).filter(x => x.t.length < ringsPerTube);
    if (!filled.length || !hasRoom.length) continue;

    const from = filled[randInt(0, filled.length - 1)];
    let targets = hasRoom.filter(x => x.i !== from.i);
    if (!targets.length) continue;
    const to = targets[randInt(0, targets.length - 1)];

    to.t.push(from.t.pop());
  }

  return state;
}

/* =====================================================================
   RENDER TUBES
===================================================================== */
function renderTubes() {
  const cfg    = DIFF_CFG[currentDiff];
  const area   = document.getElementById('tubesArea');
  const colors = COLOR_PALETTES[totalColors];
  area.innerHTML = '';

  const ringH  = 36;
  const poleH  = RINGS_PER * ringH + 20;

  tubes.forEach((tube, ti) => {
    const wrap = document.createElement('div');
    wrap.className = 'tube-wrap';
    wrap.dataset.ti = ti;
    if (isTubeDone(ti))     wrap.classList.add('done');
    if (selectedTube === ti) wrap.classList.add('selected');

    // Pole cap (top bead)
    const cap = document.createElement('div');
    cap.className = 'pole-cap';
    wrap.appendChild(cap);

    // Rings stack (sits on top of pole visually)
    const stack = document.createElement('div');
    stack.className = 'rings-stack';
    stack.style.height  = poleH + 'px';
    stack.style.width   = '72px';
    stack.style.position = 'relative';

    // Pole behind rings
    const pole = document.createElement('div');
    pole.className = 'pole';
    pole.style.height = poleH + 'px';
    stack.appendChild(pole);

    // Render rings (index 0 = bottom, last = top)
    tube.forEach((colorIdx, ri) => {
      const color  = colors[colorIdx];
      const isTop  = ri === tube.length - 1;
      const ring   = createRingSVG(color, 72, ringH, isTop && selectedTube === ti);
      ring.dataset.ri = ri;
      stack.appendChild(ring);
    });

    wrap.appendChild(stack);

    // Base
    const base = document.createElement('div');
    base.className = 'pole-base';
    wrap.appendChild(base);

    // Label
    const label = document.createElement('div');
    label.className  = 'tube-label';
    label.textContent = isTubeDone(ti) ? '‚úì' : (ti + 1);
    wrap.appendChild(label);

    wrap.addEventListener('click', () => onTubeClick(ti));
    wrap.addEventListener('touchend', e => { e.preventDefault(); onTubeClick(ti); }, { passive: false });

    area.appendChild(wrap);
  });

  document.getElementById('movesVal').textContent  = moves;
  document.getElementById('movesInfo').textContent = `${moves} movimiento${moves !== 1 ? 's' : ''}`;
  countDone();
}

/* =====================================================================
   CREATE RING SVG
===================================================================== */
function createRingSVG(color, tubeW, h, isTop) {
  const wrapper = document.createElement('div');
  wrapper.className = 'ring';
  wrapper.style.height = h + 'px';

  const cx     = tubeW / 2;
  const cy     = h / 2;
  const rOuter = tubeW / 2 - 4;
  const rInner = rOuter * 0.42;

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('width', tubeW);
  svg.setAttribute('height', h);
  svg.setAttribute('viewBox', `0 0 ${tubeW} ${h}`);
  svg.classList.add('ring-svg');

  // Outer circle
  const outer = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  outer.setAttribute('cx', cx); outer.setAttribute('cy', cy);
  outer.setAttribute('r', rOuter); outer.setAttribute('fill', color.fill);

  // Top shine
  const shine = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
  shine.setAttribute('cx', cx); shine.setAttribute('cy', cy - rOuter * 0.28);
  shine.setAttribute('rx', rOuter * 0.55); shine.setAttribute('ry', rOuter * 0.22);
  shine.setAttribute('fill', 'rgba(255,255,255,0.28)');

  // Inner hole
  const inner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  inner.setAttribute('cx', cx); inner.setAttribute('cy', cy);
  inner.setAttribute('r', rInner); inner.setAttribute('fill', 'rgba(255,255,255,0.55)');

  // Stroke border
  const stroke = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  stroke.setAttribute('cx', cx); stroke.setAttribute('cy', cy);
  stroke.setAttribute('r', rOuter); stroke.setAttribute('fill', 'none');
  stroke.setAttribute('stroke', color.stroke); stroke.setAttribute('stroke-width', '2');

  // Symbol for colorblind accessibility ‚Äî sits in the ring band
  const symR = (rOuter + rInner) / 2;  // midpoint of ring band
  const symbol = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  symbol.setAttribute('x', cx + symR * 0.72);
  symbol.setAttribute('y', cy + 0.4);
  symbol.setAttribute('text-anchor', 'middle');
  symbol.setAttribute('dominant-baseline', 'middle');
  symbol.setAttribute('font-size', Math.max(7, rOuter * 0.32));
  symbol.setAttribute('fill', 'rgba(255,255,255,0.85)');
  symbol.setAttribute('font-family', 'Arial, sans-serif');
  symbol.setAttribute('font-weight', 'bold');
  symbol.textContent = color.symbol || '‚óè';

  svg.appendChild(outer);
  svg.appendChild(shine);
  svg.appendChild(inner);
  svg.appendChild(stroke);
  svg.appendChild(symbol);
  wrapper.appendChild(svg);
  return wrapper;
}

/* =====================================================================
   TUBE CLICK LOGIC
===================================================================== */
function onTubeClick(ti) {
  if (!gameRunning) return;

  if (selectedTube === null) {
    // Select this tube if it has rings and isn't done
    if (tubes[ti].length === 0) {
      showToast('Este tubo est√° vac√≠o ü§î');
      return;
    }
    if (isTubeDone(ti)) {
      showToast('¬°Este tubo ya est√° completo! ‚úì');
      return;
    }
    selectedTube = ti;
    renderTubes();
    return;
  }

  if (selectedTube === ti) {
    // Deselect
    selectedTube = null;
    renderTubes();
    return;
  }

  // Try to move top ring from selectedTube ‚Üí ti
  const from = selectedTube;
  const to   = ti;

  if (canMove(from, to)) {
    // Save history
    history.push(tubes.map(t => [...t]));

    // ‚îÄ‚îÄ FLYING RING ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    isAnimating = true;
    animateFlyingRing(from, to, () => {
      const ring = tubes[from].pop();
      tubes[to].push(ring);
      moves++;
      isAnimating = false;
      renderTubes();
      if (checkWin()) setTimeout(() => endGame(true), 300);
    });
  } else {
    // Can't drop ‚Äî shake the target tube and show fake-move on top ring of source
    shakeTube(to);
    fakeMove(from);
    showToast(cantMoveMsg(from, to));
  }
}

function cantMoveMsg(from, to) {
  if (tubes[to].length >= RINGS_PER) return '¬°El tubo est√° lleno! üö´';
  return '¬°Movimiento inv√°lido! üö´';
}

/* =====================================================================
   CAN MOVE ‚Äî only restriction: target must have room
===================================================================== */
function canMove(from, to) {
  if (from === to) return false;
  if (tubes[from].length === 0) return false;
  if (tubes[to].length >= RINGS_PER) return false;
  return true;
}

/* =====================================================================
   ANIMATIONS: SHAKE TUBE, FAKE RING MOVE
===================================================================== */
function shakeTube(ti) {
  const wraps = document.querySelectorAll('.tube-wrap');
  const wrap  = wraps[ti];
  if (!wrap) return;
  wrap.classList.remove('cant-drop');
  void wrap.offsetWidth;
  wrap.classList.add('cant-drop');
  wrap.addEventListener('animationend', () => wrap.classList.remove('cant-drop'), { once: true });
}

function fakeMove(ti) {
  const wraps  = document.querySelectorAll('.tube-wrap');
  const wrap   = wraps[ti];
  if (!wrap) return;
  const rings  = wrap.querySelectorAll('.ring');
  const topRing = rings[rings.length - 1];
  if (!topRing) return;
  topRing.classList.remove('fake-move');
  void topRing.offsetWidth;
  topRing.classList.add('fake-move');
  topRing.addEventListener('animationend', () => topRing.classList.remove('fake-move'), { once: true });
}

/* =====================================================================
   FLYING RING ANIMATION
===================================================================== */
function animateFlyingRing(fromTi, toTi, onComplete) {
  const wraps   = document.querySelectorAll('.tube-wrap');
  const fromWrap = wraps[fromTi];
  const toWrap   = wraps[toTi];
  if (!fromWrap || !toWrap) { onComplete(); return; }

  // Find the top ring element in the source tube
  const rings   = fromWrap.querySelectorAll('.ring');
  const topRing = rings[rings.length - 1];
  if (!topRing) { onComplete(); return; }

  // Get bounding rects
  const fromRect = topRing.getBoundingClientRect();

  // Compute destination: top of destination stack
  const toStack  = toWrap.querySelector('.rings-stack');
  const toRect   = toStack ? toStack.getBoundingClientRect() : toWrap.getBoundingClientRect();
  const destCount = tubes[toTi].length; // rings already in dest
  const ringH    = 36;
  // Position = bottom of stack area minus rings already there
  const destY = toRect.bottom - (destCount + 1) * (ringH + 2) - ringH / 2;
  const destX = toRect.left + toRect.width / 2 - fromRect.width / 2;

  // Clone the ring element as a fixed overlay
  const clone = topRing.cloneNode(true);
  clone.style.cssText = `
    position: fixed;
    left: ${fromRect.left}px;
    top:  ${fromRect.top}px;
    width: ${fromRect.width}px;
    height: ${fromRect.height}px;
    pointer-events: none;
    z-index: 9999;
    transition: none;
    margin: 0;
  `;
  document.body.appendChild(clone);

  // Hide original ring while clone is flying
  topRing.style.opacity = '0';

  // Animate: arc up then drop to destination
  const startX = fromRect.left;
  const startY = fromRect.top;
  const peakY  = Math.min(startY, destY) - 80;   // arc peak
  const dur    = 220; // ms
  const start  = performance.now();

  function step(now) {
    const t  = Math.min((now - start) / dur, 1);
    const et = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; // ease-in-out

    // Bezier-like arc: lerp X linearly, Y via quadratic arc
    const x = startX + (destX - startX) * et;
    // Quadratic bezier for Y: P0=startY, P1=peakY, P2=destY
    const mt = 1 - et;
    const y  = mt * mt * startY + 2 * mt * et * peakY + et * et * destY;

    clone.style.left = x + 'px';
    clone.style.top  = y + 'px';

    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      clone.remove();
      onComplete();
    }
  }
  requestAnimationFrame(step);
}

/* =====================================================================
   IS TUBE DONE
===================================================================== */
function isTubeDone(ti) {
  const tube = tubes[ti];
  if (tube.length !== RINGS_PER) return false;
  return tube.every(c => c === tube[0]);
}

function countDone() {
  let done = 0;
  tubes.forEach((_, ti) => { if (isTubeDone(ti)) done++; });
  doneTubes = done;
  document.getElementById('doneVal').textContent = done;
  document.getElementById('doneSub').textContent = `de ${totalColors}`;
}

/* =====================================================================
   CHECK WIN
===================================================================== */
function checkWin() {
  countDone();
  return doneTubes === totalColors;
}

/* =====================================================================
   UNDO
===================================================================== */
function undoMove() {
  if (!history.length) { showToast('No hay movimientos que deshacer ü§∑'); return; }
  tubes = history.pop();
  if (moves > 0) moves--;
  selectedTube = null;
  renderTubes();
  showToast('Movimiento deshecho ‚Ü©Ô∏è');
}

/* =====================================================================
   RESET
===================================================================== */
function resetGame() {
  startGame(currentDiff);
}

/* =====================================================================
   TIMER
===================================================================== */
function startTimer(cfg) {
  stopTimer();
  timeLeft  = cfg.time;
  totalTime = cfg.time;
  startTime = Date.now();

  if (cfg.time === 0) {
    // Count up
    document.getElementById('timerText').textContent = '‚àû';
    document.getElementById('timerCircle').style.strokeDasharray  = CIRC;
    document.getElementById('timerCircle').style.strokeDashoffset = 0;
    document.getElementById('timerCircle').style.stroke = 'url(#timerGrad)';
    timerInt = setInterval(() => {
      elapsed = Math.floor((Date.now() - startTime) / 1000);
    }, 1000);
    return;
  }

  updateTimerUI();
  timerInt = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    if (timeLeft <= 0) {
      stopTimer();
      gameRunning = false;
      endGame(false);
    }
  }, 1000);
}

function stopTimer() {
  if (timerInt) { clearInterval(timerInt); timerInt = null; }
}

function updateTimerUI() {
  const circle = document.getElementById('timerCircle');
  const text   = document.getElementById('timerText');
  const pct    = timeLeft / totalTime;
  const offset = CIRC * (1 - pct);
  circle.style.strokeDasharray  = CIRC;
  circle.style.strokeDashoffset = offset;

  const mins = Math.floor(timeLeft / 60);
  const secs = timeLeft % 60;
  text.textContent = `${mins}:${String(secs).padStart(2, '0')}`;

  if (pct > 0.5) {
    circle.style.stroke = 'url(#timerGrad)';
    text.className = 'timer-text';
  } else if (pct > 0.25) {
    circle.style.stroke = '#ffc844';
    text.className = 'timer-text';
  } else {
    circle.style.stroke = '#ff6b6b';
    text.className = 'timer-text urgent';
  }
}

/* =====================================================================
   END GAME
===================================================================== */
function endGame(won) {
  stopTimer();
  gameRunning = false;
  elapsed = Math.floor((Date.now() - startTime) / 1000);

  if (won) {
    document.getElementById('winMoves').textContent = moves;
    document.getElementById('winMsg').textContent   = WIN_MSGS[randInt(0, WIN_MSGS.length - 1)];
    document.getElementById('scoreNameInput').value = '';
    document.getElementById('scoreForm').style.display = '';
    document.getElementById('winBtns').style.display   = 'none';
    showScreen('screen-win');
  } else {
    document.getElementById('loseMsg').textContent = LOSE_MSGS[randInt(0, LOSE_MSGS.length - 1)];
    showScreen('screen-lose');
  }
}

/* =====================================================================
   SCORE SAVE
===================================================================== */
function saveScore() {
  const name = document.getElementById('scoreNameInput').value.trim();
  if (!name) { showToast('Escribe tu nombre primero üòä'); return; }

  const key  = `or_scores_${currentDiff}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  list.push({ name, moves, elapsed, diff: currentDiff });
  list.sort((a, b) => a.moves - b.moves || a.elapsed - b.elapsed);
  if (list.length > 10) list.splice(10);
  localStorage.setItem(key, JSON.stringify(list));

  document.getElementById('scoreForm').style.display = 'none';
  document.getElementById('winBtns').style.display   = 'flex';
  showToast('¬°Puntaje guardado! üèÜ');
  renderLeaderboard();
}

function skipScore() {
  document.getElementById('scoreForm').style.display = 'none';
  document.getElementById('winBtns').style.display   = 'flex';
}

/* =====================================================================
   LEADERBOARD
===================================================================== */
function showLbTab(diff, btn) {
  currentLbTab = diff;
  document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLeaderboard();
}

function renderLeaderboard() {
  const key  = `or_scores_${currentLbTab}`;
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  const ul   = document.getElementById('lbList');
  ul.innerHTML = '';

  if (!list.length) {
    ul.innerHTML = '<li class="lb-empty">A√∫n no hay puntajes. ¬°S√© el primero!</li>';
    return;
  }

  list.forEach((entry, i) => {
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
    ul.innerHTML += `
      <li class="lb-row">
        <span class="lb-pos">${medal}</span>
        <span class="lb-name">${escHtml(entry.name)}</span>
        <span class="lb-score">${entry.moves} mov.</span>
      </li>`;
  });
}

/* =====================================================================
   UTILS
===================================================================== */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

/* BOOT */
renderLeaderboard();

// Click outside any tube ‚Üí deselect
document.getElementById('tubesArea').addEventListener('click', e => {
  if (!gameRunning) return;
  if (!e.target.closest('.tube-wrap') && selectedTube !== null) {
    selectedTube = null;
    renderTubes();
  }
});
// Also catch clicks anywhere else on game screen
document.getElementById('screen-game').addEventListener('click', e => {
  if (!gameRunning) return;
  if (!e.target.closest('.tube-wrap') && !e.target.closest('.left-panel') && selectedTube !== null) {
    selectedTube = null;
    renderTubes();
  }
});
</script>
</body>
</html>
